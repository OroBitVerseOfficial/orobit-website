<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OroBit Staking: Invierte en Oro y Bitcoin</title>
    <!--
        Content Security Policy (CSP) para permitir el funcionamiento de la aplicaci√≥n en entornos locales.
        ADVERTENCIA: 'unsafe-eval' y 'unsafe-inline' relajan la seguridad y NO deben usarse en producci√≥n.
        Se incluyen para la fase de desarrollo y pruebas locales.
    -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com;
        img-src 'self' https://placehold.co data:;
        connect-src 'self' https://data-seed-prebsc-1-s1.binance.org:8545/ https://bscscan.com https://testnet.bscscan.com/ https://pancakeswap.finance;
        font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
    ">
    
    <!-- Favicon de OroBit - Usando la imagen de tu logo -->
    <link rel="icon" href="../images/Dise√±o sin t√≠tulo (16).png" type="image/png">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://placehold.co/1920x1080/1a202c/e2e8f0?text=Circuito+Digital+Oro+Bitcoin'); /* Fondo tem√°tico */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .container {
            max-width: 800px; /* Un poco m√°s grande para el nuevo contenido */
            background-color: rgba(255, 255, 255, 0.08); /* Fondo blanco con opacidad */
            backdrop-filter: blur(10px); /* Efecto de desenfoque detr√°s */
            border: 1px solid rgba(255, 255, 255, 0.1); /* Borde sutil */
            border-radius: 1.5rem; /* Bordes m√°s redondeados */
            padding: 2.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.15); /* Sombra m√°s pronunciada */
        }
        input, button, select {
            border-radius: 0.75rem; /* rounded-xl */
        }
        /* Estilos espec√≠ficos para un mejor aspecto en m√≥viles */
        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
                margin: 1rem;
            }
            h1 {
                font-size: 2rem;
            }
            h2 {
                font-size: 1.5rem;
            }
        }
        /* Estilo para las pesta√±as de navegaci√≥n */
        .tab-button {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: #a78bfa; /* purple-300 */
        }
        .tab-button.active {
            border-color: #8b5cf6; /* purple-500 */
            color: #d8b4fe; /* purple-200 */
            background-color: rgba(139, 92, 246, 0.1); /* purple-500 con opacidad */
        }
        .tab-content {
            display: none;
            padding-top: 1.5rem;
        }
        .tab-content.active {
            display: block;
        }
        /* Estilo para los cards de pool */
        .pool-card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }
        /* Estilos para el encabezado de la app de staking */
        .staking-app-header {
            display: flex;
            align-items: center;
            justify-content: center; /* Centrar para pantallas peque√±as */
            margin-bottom: 1.5rem;
            flex-wrap: wrap; /* Permitir que los elementos se envuelvan en pantallas peque√±as */
            text-align: center;
        }
        .staking-app-header .logo-container {
            display: flex;
            align-items: center;
            margin-right: 1rem; /* Espacio entre logo y t√≠tulo */
        }
        @media (max-width: 640px) { /* Ajuste para m√≥viles */
            .staking-app-header {
                flex-direction: column; /* Apilar elementos verticalmente */
            }
            .staking-app-header .logo-container {
                margin-right: 0;
                margin-bottom: 0.5rem; /* Espacio debajo del logo */
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-800 to-purple-900 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="container text-white">
        <!-- Encabezado de la Aplicaci√≥n de Staking con Logo -->
        <div class="staking-app-header">
            <div class="logo-container">
                <img src="../images/Dise√±o sin t√≠tulo (16).png" alt="Logo de OroBit" class="h-10 rounded-full shadow-lg mr-2"> <!-- Ruta relativa al index.html -->
                <h1 class="text-4xl font-extrabold text-yellow-300 drop-shadow-lg">
                    OroBit Staking <i class="fas fa-gem ml-2 text-blue-400"></i>
                </h1>
            </div>
        </div>
        <p class="text-base text-center mb-8 text-gray-300">
            Invierte en Oro y Bitcoin: Sencillo. Seguro. Rentable.
        </p>

        <!-- Contrato de Staking de OroBit Address (Read-only) -->
        <div class="mb-4 text-center">
            <label for="stakingContractAddress" class="block text-sm font-medium text-indigo-300 mb-1">Contrato Inteligente:</label>
            <input type="text" id="stakingContractAddress" value="0x8278ebadbc25beea94d6370174b8eeb7b5bfd253" class="w-full p-2 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 text-center focus:outline-none focus:ring-2 focus:ring-purple-500" readonly>
            <p class="text-xs text-gray-400 mt-1">Conectado a la BNB Smart Chain Testnet</p>
        </div>

        <!-- Conexi√≥n a MetaMask -->
        <button id="connectWalletBtn" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
            <i class="fab fa-ethereum mr-2 text-lg"></i> Conectar MetaMask
        </button>
        <p id="walletStatus" class="text-center text-sm mt-3 text-indigo-300"></p>
        <p id="accountAddress" class="text-center text-xs mt-1 text-gray-400 break-all"></p>

        <hr class="border-t border-gray-700 my-8">

        <!-- Pesta√±as de Navegaci√≥n -->
        <div class="flex justify-center mb-6 border-b border-gray-700">
            <button class="tab-button active" data-tab="dashboard-tab">
                <i class="fas fa-tachometer-alt mr-2"></i> Mi Dashboard
            </button>
            <button class="tab-button" data-tab="stake-tab">
                <i class="fas fa-hand-holding-usd mr-2"></i> Stakear
            </button>
            <button class="tab-button" data-tab="withdraw-tab">
                <i class="fas fa-coins mr-2"></i> Retirar
            </button>
            <button class="tab-button" data-tab="admin-tab">
                <i class="fas fa-user-shield mr-2"></i> Admin
            </button>
        </div>

        <!-- Contenido del Dashboard -->
        <div id="dashboard-tab" class="tab-content active">
            <h2 class="text-2xl font-bold mb-4 text-center text-yellow-200">üìä Mi Resumen de Staking</h2>
            <div class="space-y-4">
                <div class="pool-card">
                    <p class="text-indigo-300 font-semibold mb-2">Su Saldo de OroBit:</p>
                    <p id="userOrobitBalance" class="text-xl text-yellow-100"><i class="fas fa-spinner fa-spin mr-2"></i>Cargando...</p>
                </div>
                <div class="pool-card">
                    <p class="text-indigo-300 font-semibold mb-2">Total de sus Stakes Activos:</p>
                    <p id="userTotalStakes" class="text-xl text-yellow-100"><i class="fas fa-spinner fa-spin mr-2"></i>Cargando...</p>
                    <div id="userStakesList" class="mt-4 text-gray-300 text-sm space-y-2">
                        <!-- Los stakes del usuario se cargar√°n aqu√≠ -->
                    </div>
                </div>

                <!-- Secci√≥n para a√±adir un pool r√°pido si no hay -->
                <div id="noPoolsMessage" class="pool-card hidden">
                    <h3 class="text-xl font-bold mb-3 text-red-300"><i class="fas fa-exclamation-triangle mr-2"></i> ¬°No hay Pools de Staking!</h3>
                    <p class="text-sm text-gray-300 mb-4">
                        Parece que no hay pools de staking activos. Como propietario, puede a√±adir uno desde aqu√≠.
                    </p>
                    <div class="space-y-3">
                        <div>
                            <label for="quickAddPoolDuration" class="block text-sm font-medium text-indigo-300 mb-1">Duraci√≥n (segundos, 0 para flexible):</label>
                            <input type="number" id="quickAddPoolDuration" value="2592000" min="0" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label for="quickAddPoolAprBP" class="block text-sm font-medium text-indigo-300 mb-1">APR (Basis Points, Ej. 500 para 5%):</label>
                            <input type="number" id="quickAddPoolAprBP" value="2000" min="0" max="100000" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="quickAddPoolIsFlexible" class="h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                            <label for="quickAddPoolIsFlexible" class="ml-2 block text-sm text-indigo-300">Es Flexible</label>
                        </div>
                        <button id="quickAddPoolBtn" class="w-full bg-purple-700 hover:bg-purple-800 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                            <i class="fas fa-plus-circle mr-2"></i> A√±adir Pool R√°pido
                        </button>
                    </div>
                </div>

                <!-- Nueva secci√≥n para adquirir OroBit -->
                <div class="pool-card">
                    <h3 class="text-xl font-bold mb-3 text-indigo-200"><i class="fas fa-coins mr-2"></i> ¬øNecesita m√°s OroBit?</h3>
                    <p class="text-sm text-gray-300 mb-4">
                        Adquiera tokens OroBit para comenzar a stakear y ganar recompensas.
                        Puede obtenerlos a trav√©s de intercambios descentralizados (DEX).
                        <span class="font-semibold text-yellow-300">¬°Recuerde, aunque el token se llama "OroBit", el proyecto principal podr√≠a tener un nombre m√°s distintivo en el futuro para evitar confusiones. ¬°Estamos en Testnet!</span>
                    </p>
                    <a id="acquireOrobitBtn" href="#" target="_blank" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                        <i class="fas fa-exchange-alt mr-2"></i> Adquirir OroBit (PancakeSwap Testnet)
                    </a>
                    <p class="text-xs text-gray-400 mt-2 text-center">
                        Para operaciones en Testnet, use PancakeSwap Testnet. Para Mainnet, use la plataforma oficial.
                        <!-- Para incluir tu enlace de afiliado de PancakeSwap en Mainnet, modifica el 'href' de arriba. -->
                    </p>
                </div>

                <!-- Secci√≥n para enlaces de afiliados -->
                <div class="pool-card">
                    <h3 class="text-xl font-bold mb-3 text-indigo-200"><i class="fas fa-link mr-2"></i> Enlaces de Afiliados</h3>
                    <p class="text-sm text-gray-300 mb-4">
                        Reg√≠strate o opera en nuestros exchanges afiliados y apoya el ecosistema OroBit.
                    </p>
                    <div class="flex flex-col space-y-3">
                        <a href="https://www.binance.com/referral/mystery-box/eu-rewardbox/claim?ref=GRO_18422_RAHG6" target="_blank" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                            <i class="fas fa-coins mr-2"></i> Binance
                        </a>
                        <a href="https://www.kucoin.com/r/rf/CX8HVQCY" target="_blank" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-900 font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                            <i class="fas fa-coins mr-2"></i> KuCoin
                        </a>
                        <a href="https://advanced.coinbase.com/join/83MUVTN" target="_blank" class="w-full bg-blue-400 hover:bg-blue-500 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                            <i class="fas fa-coins mr-2"></i> Coinbase
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido de Stakear -->
        <div id="stake-tab" class="tab-content">
            <h2 class="text-2xl font-bold mb-4 text-center text-yellow-200">üöÄ Stakear OroBit</h2>
            <div class="space-y-4">
                <div>
                    <label for="stakeAmountInput" class="block text-sm font-medium text-indigo-300 mb-1">
                        Cantidad a Stakear (OroBit):
                    </label>
                    <div class="relative flex">
                        <input type="number" id="stakeAmountInput" value="1" min="0.000000000000000001" step="0.000000000000000001" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 pr-12">
                        <button id="maxStakeAmountBtn" class="absolute inset-y-0 right-0 flex items-center px-4 text-sm font-semibold text-purple-200 bg-purple-600 hover:bg-purple-700 rounded-r-lg transition duration-200 ease-in-out">
                            MAX
                        </button>
                    </div>
                </div>
                <div>
                    <label for="poolSelect" class="block text-sm font-medium text-indigo-300 mb-1">Seleccione un Pool:</label>
                    <select id="poolSelect" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="" disabled selected>Cargando pools...</option>
                    </select>
                </div>
                <button id="approveStakeBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                    <i class="fas fa-check-circle mr-2"></i> Aprobar Staking
                </button>
                <button id="stakeBtn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center" disabled>
                    <i class="fas fa-layer-group mr-2"></i> Confirmar Stake
                </button>
            </div>
        </div>

        <!-- Contenido de Retirar -->
        <div id="withdraw-tab" class="tab-content">
            <h2 class="text-2xl font-bold mb-4 text-center text-yellow-200">üí∏ Retirar OroBit</h2>
            <div class="space-y-4">
                <div>
                    <label for="withdrawStakeIdInput" class="block text-sm font-medium text-indigo-300 mb-1">ID del Stake a Retirar:</label>
                    <input type="number" id="withdrawStakeIdInput" value="0" min="0" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <button id="executeWithdrawBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center" disabled>
                    <i class="fas fa-wallet mr-2"></i> Retirar Stake
                </button>
            </div>
        </div>

        <!-- Contenido del Panel de Admin -->
        <div id="admin-tab" class="tab-content">
            <h2 class="text-2xl font-bold mb-4 text-center text-red-300">üõ°Ô∏è Panel de Administraci√≥n</h2>
            <p class="text-sm text-gray-400 mb-6 text-center">Solo visible para el propietario del contrato.</p>
            <div class="space-y-4">
                <div class="pool-card">
                    <h3 class="text-xl font-bold mb-2 text-indigo-200">A√±adir Nuevo Pool de Staking</h3>
                    <div>
                        <label for="adminPoolDuration" class="block text-sm font-medium text-indigo-300 mb-1">Duraci√≥n (segundos, 0 para flexible):</label>
                        <input type="number" id="adminPoolDuration" value="2592000" min="0" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="adminPoolAprBP" class="block text-sm font-medium text-indigo-300 mb-1">APR (Basis Points, Ej. 500 para 5%):</label>
                        <input type="number" id="adminPoolAprBP" value="2000" min="0" max="100000" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="adminPoolIsFlexible" class="h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                        <label for="adminPoolIsFlexible" class="ml-2 block text-sm text-indigo-300">Es Flexible</label>
                    </div>
                    <button id="addPoolBtn" class="w-full mt-4 bg-purple-700 hover:bg-purple-800 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                        <i class="fas fa-plus-circle mr-2"></i> A√±adir Pool
                    </button>
                </div>

                <div class="pool-card">
                    <h3 class="text-xl font-bold mb-2 text-indigo-200">Actualizar Estado de Pool</h3>
                    <div>
                        <label for="adminSetPoolId" class="block text-sm font-medium text-indigo-300 mb-1">ID del Pool:</label>
                        <input type="number" id="adminSetPoolId" value="0" min="0" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="adminSetPoolActive" checked class="h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                        <label for="adminSetPoolActive" class="ml-2 block text-sm text-indigo-300">Activo</label>
                    </div>
                    <button id="setPoolStatusBtn" class="w-full mt-4 bg-purple-700 hover:bg-purple-800 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                        <i class="fas fa-toggle-on mr-2"></i> Actualizar Estado
                    </button>
                </div>

                <div class="pool-card">
                    <h3 class="text-xl font-bold mb-2 text-indigo-200">Depositar Recompensas (OroBit)</h3>
                    <div>
                        <label for="depositRewardsAmount" class="block text-sm font-medium text-indigo-300 mb-1">Cantidad a Depositar:</label>
                        <input type="number" id="depositRewardsAmount" value="100" min="1" step="0.000000000000000001" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <button id="depositRewardsBtn" class="w-full mt-4 bg-purple-700 hover:bg-purple-800 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                        <i class="fas fa-hand-holding-heart mr-2"></i> Depositar
                    </button>
                </div>

                <div class="pool-card">
                    <h3 class="text-xl font-bold mb-2 text-indigo-200">Actualizar Penalizaci√≥n por Retiro Anticipado</h3>
                    <div>
                        <label for="earlyWithdrawPenaltyBP" class="block text-sm font-medium text-indigo-300 mb-1">Penalizaci√≥n (Basis Points, 0-10000):</label>
                        <input type="number" id="earlyWithdrawPenaltyBP" value="2000" min="0" max="10000" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <button id="setEarlyWithdrawPenaltyBtn" class="w-full mt-4 bg-purple-700 hover:bg-purple-800 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                        <i class="fas fa-gavel mr-2"></i> Establecer Penalizaci√≥n
                    </button>
                </div>
            </div>
        </div>

        <!-- √Årea de Mensajes Global -->
        <div id="messageArea" class="mt-8 p-4 bg-gray-800 bg-opacity-50 rounded-lg text-gray-200 text-sm">
            <p id="statusMessage" class="font-semibold"></p>
            <p id="errorMessage" class="text-red-400 mt-2"></p>
            <p id="txHash" class="break-words mt-2"></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        // --- Configuraciones de la Blockchain ---
        const STAKING_CONTRACT_ADDRESS = "0x8278ebadbc25beea94d6370174b8eeb7b5bfd253"; // Contrato de Staking
        const OROBIT_TOKEN_ADDRESS = "0x8bC4B9238047843C3Cb0508b9EdeB3a7729D72c3"; // Contrato del Token OroBit
        const BNB_TESTNET_CHAIN_ID = '0x61'; // Chain ID para BNB Smart Chain Testnet
        const BNB_TESTNET_RPC_URL = 'https://data-seed-prebsc-1-s1.binance.org:8545/'; // RPC URL de la testnet
        const OWNER_WALLET_ADDRESS = "0x0C6DA70B1BB307D78d154ec6adbD57ff696E0660"; // Su cartera de propietario (REAL)
        const ADRIANA_WALLET_ADDRESS = "0x74ee74CA4e9deE9b15bC34aAc6615F324BAf2Bc5"; // Cartera de ADRIANA (para pruebas de usuario est√°ndar)


        // URL para adquirir OroBit en PancakeSwap Testnet
        const PANCAKESWAP_TESTNET_URL = `https://pancakeswap.finance/swap?outputCurrency=${OROBIT_TOKEN_ADDRESS}&chainId=${parseInt(BNB_TESTNET_CHAIN_ID, 16)}`;


        // --- ABIs de los Contratos ---
        // ABI del Contrato de Staking (simplificado para funciones clave)
        const STAKING_CONTRACT_ABI = [
            // Funciones de Read Contract
            { "inputs": [], "name": "getContractTokenBalance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_poolId", "type": "uint256" }], "name": "getPool", "outputs": [{ "internalType": "uint256", "name": "duration", "type": "uint256" }, { "internalType": "uint256", "name": "aprBP", "type": "uint256" }, { "internalType": "bool", "name": "isActive", "type": "bool" }, { "internalType": "bool", "name": "isFlexible", "type": "bool" }], "stateMutability": "view", "type": "function" },
            { "inputs": [], "name": "getStakingPoolsLength", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, // Corregido: getStakingPoolsLength
            { "inputs": [{ "internalType": "address", "name": "_user", "type": "address" }, { "internalType": "uint256", "name": "_stakeId", "type": "uint256" }], "name": "getUserStake", "outputs": [{ "internalType": "uint256", "name": "amount", "type": "uint256" }, { "internalType": "uint256", "name": "startTime", "type": "uint256" }, { "internalType": "uint256", "name": "duration", "type": "uint256" }, { "internalType": "uint256", "name": "aprBP", "type": "uint256" }, { "internalType": "bool", "name": "withdrawn", "type": "bool" }, { "internalType": "uint256", "name": "lastRewardClaimed", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "address", "name": "_user", "type": "address" }], "name": "getUserStakesLength", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [], "name": "owner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
            { "inputs": [], "name": "earlyWithdrawPenaltyBP", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "address", "name": "_user", "type": "address" }, { "internalType": "uint256", "name": "_stakeId", "type": "uint256" }], "name": "calculateReward", "outputs": [{ "internalType": "uint256", "name": "reward", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            // Funciones de Write Contract
            { "inputs": [{ "internalType": "uint256", "name": "_poolId", "type": "uint256" }, { "internalType": "uint256", "name": "_amount", "type": "uint256" }], "name": "stake", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_stakeId", "type": "uint256" }], "name": "withdraw", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_duration", "type": "uint256" }, { "internalType": "uint256", "name": "_aprBP", "type": "uint256" }, { "internalType": "bool", "name": "_isFlexible", "type": "bool" }], "name": "addPool", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_poolId", "type": "uint256" }, { "internalType": "bool", "name": "_isActive", "type": "bool" }], "name": "setPoolStatus", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_amount", "type": "uint256" }], "name": "depositRewards", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_newPenaltyBP", "type": "uint256" }], "name": "setEarlyWithdrawPenalty", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [], "name": "pause", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [], "name": "unpause", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
        ];

        // ABI del Contrato IERC20 (para el token OroBit)
        const OROBIT_TOKEN_ABI = [
            { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "balanceOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "approve", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }], "name": "allowance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }
        ];

        // --- Variables Globales ---
        let web3; // Instancia de Web3
        let stakingContract; // Instancia del contrato de staking
        let oroBitTokenContract; // Instancia del contrato del token OroBit
        let currentAccount; // Cuenta de MetaMask conectada
        let isOwner = false; // Bandera para verificar si la cuenta conectada es el propietario
        let currentUserOrobitBalance = '0'; // Almacenar el saldo de OroBit del usuario


        // --- Referencias a Elementos del DOM ---
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const walletStatus = document.getElementById('walletStatus');
        const accountAddressElem = document.getElementById('accountAddress');
        const statusMessage = document.getElementById('statusMessage');
        const errorMessage = document.getElementById('errorMessage');
        const txHashElem = document.getElementById('txHash');

        // Pesta√±as
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Dashboard
        const userOrobitBalanceElem = document.getElementById('userOrobitBalance');
        const userTotalStakesElem = document.getElementById('userTotalStakes');
        const userStakesListElem = document.getElementById('userStakesList');
        const acquireOrobitBtn = document.getElementById('acquireOrobitBtn'); // Nuevo elemento
        const noPoolsMessage = document.getElementById('noPoolsMessage'); // Nuevo elemento
        const quickAddPoolBtn = document.getElementById('quickAddPoolBtn'); // Nuevo elemento
        const quickAddPoolDuration = document.getElementById('quickAddPoolDuration'); // Nuevo elemento
        const quickAddPoolAprBP = document.getElementById('quickAddPoolAprBP'); // Nuevo elemento
        const quickAddPoolIsFlexible = document.getElementById('quickAddPoolIsFlexible'); // Nuevo elemento

        // Stake
        const stakeAmountInput = document.getElementById('stakeAmountInput');
        const maxStakeAmountBtn = document.getElementById('maxStakeAmountBtn'); // Nuevo bot√≥n MAX
        const poolSelect = document.getElementById('poolSelect');
        const approveStakeBtn = document.getElementById('approveStakeBtn');
        const stakeBtn = document.getElementById('stakeBtn');

        // Withdraw
        const withdrawStakeIdInput = document.getElementById('withdrawStakeIdInput');
        const executeWithdrawBtn = document.getElementById('executeWithdrawBtn');

        // Admin
        const adminTab = document.getElementById('admin-tab');
        const adminPoolDuration = document.getElementById('adminPoolDuration');
        const adminPoolAprBP = document.getElementById('adminPoolAprBP');
        const adminPoolIsFlexible = document.getElementById('adminPoolIsFlexible'); 
        const addPoolBtn = document.getElementById('addPoolBtn');
        const adminSetPoolId = document.getElementById('adminSetPoolId');
        const adminSetPoolActive = document.getElementById('adminSetPoolActive');
        const setPoolStatusBtn = document.getElementById('setPoolStatusBtn');
        const depositRewardsAmount = document.getElementById('depositRewardsAmount');
        const depositRewardsBtn = document.getElementById('depositRewardsBtn'); 
        const earlyWithdrawPenaltyBP = document.getElementById('earlyWithdrawPenaltyBP');
        const setEarlyWithdrawPenaltyBtn = document.getElementById('setEarlyWithdrawPenaltyBtn');

        // --- Funciones de Utilidad ---

        // Funci√≥n para decodificar mensajes de revert (error de contrato)
        function decodeRevertReason(hexString) {
            if (!hexString || hexString.length < 10) return "Raz√≥n de revert desconocida";
            if (hexString.startsWith('0x08c379a0')) { // Selector de error para Solidity's `Error(string)`
                try {
                    const dataPart = hexString.substring(10);
                    let decoded = '';
                    for (let i = 0; i < dataPart.length; i += 2) {
                        decoded += String.fromCharCode(parseInt(dataPart.substr(i, 2), 16));
                    }
                    decoded = decoded.replace(/[^ -~]+/g, ''); // Limpiar caracteres no ASCII
                    if (decoded.length > 0) return `Revert: "${decoded.trim()}"`;
                } catch (e) {
                    console.warn("Error decodificando raz√≥n de revert:", e);
                }
            }
            return "Revert: Sin mensaje de error claro (hex: " + hexString.substring(0, Math.min(hexString.length, 100)) + "...)";
        }

        // Funci√≥n para resetear mensajes en la interfaz de usuario
        function resetMessages() {
            statusMessage.textContent = '';
            errorMessage.textContent = '';
            txHashElem.textContent = '';
        }

        // Funci√≥n para convertir de Wei a OroBit (y otras criptomonedas con 18 decimales)
        function fromWei(amountInWei) {
            if (!web3) return 'N/A';
            return web3.utils.fromWei(amountInWei, 'ether');
        }

        // Funci√≥n para convertir de OroBit a Wei (para enviar a la blockchain)
        function toWei(amountInOroBit) {
            if (!web3) return 'N/A';
            return web3.utils.toWei(amountInOroBit, 'ether');
        }

        // Funci√≥n para actualizar el estado visual del bot√≥n de conexi√≥n
        function updateConnectButtonStatus(status) {
            const icon = connectWalletBtn.querySelector('i');
            switch (status) {
                case 'connecting':
                    connectWalletBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2 text-lg"></i> Conectando...';
                    connectWalletBtn.disabled = true;
                    connectWalletBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700');
                    connectWalletBtn.classList.add('bg-purple-600', 'to-indigo-600', 'hover:from-purple-700', 'hover:to-indigo-700');
                    break;
                case 'connected':
                    connectWalletBtn.innerHTML = '<i class="fas fa-check-circle mr-2 text-lg"></i> MetaMask Conectado';
                    connectWalletBtn.disabled = true; // Deshabilitar despu√©s de conectar
                    connectWalletBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-purple-600', 'to-indigo-600', 'hover:from-purple-700', 'hover:to-indigo-700');
                    connectWalletBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    break;
                case 'disconnected':
                    connectWalletBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2 text-lg"></i> Conectar MetaMask';
                    connectWalletBtn.disabled = false;
                    connectWalletBtn.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-purple-600', 'to-indigo-600', 'hover:from-purple-700', 'hover:to-indigo-700');
                    connectWalletBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    break;
                case 'error':
                    connectWalletBtn.innerHTML = '<i class="fas fa-times-circle mr-2 text-lg"></i> Error de Conexi√≥n';
                    connectWalletBtn.disabled = false;
                    connectWalletBtn.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-purple-600', 'to-indigo-600', 'hover:from-purple-700', 'hover:to-indigo-700');
                    connectWalletBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    break;
                default:
                    connectWalletBtn.innerHTML = '<i class="fab fa-ethereum mr-2 text-lg"></i> Conectar MetaMask';
                    connectWalletBtn.disabled = false;
                    connectWalletBtn.classList.remove('bg-green-600', 'bg-red-600', 'hover:bg-green-700', 'hover:bg-red-700');
                    connectWalletBtn.classList.add('bg-purple-600', 'to-indigo-600', 'hover:from-purple-700', 'hover:to-indigo-700');
                    break;
            }
        }


        // --- L√≥gica de Conexi√≥n a MetaMask ---
        async function connectWallet() {
            resetMessages();
            updateConnectButtonStatus('connecting'); // Actualizar bot√≥n a "Conectando..."
            console.log("DEBUG: connectWallet: Iniciando conexi√≥n a MetaMask...");

            let attempts = 0;
            const maxAttempts = 5; // Intentar detectar MetaMask varias veces
            const retryDelay = 300; // Milisegundos entre intentos

            while (typeof window.ethereum === 'undefined' || !window.ethereum) {
                if (attempts >= maxAttempts) {
                    walletStatus.textContent = 'MetaMask no detectado.';
                    errorMessage.textContent = 'Por favor, instale MetaMask para usar esta aplicaci√≥n. Si ya lo tiene, aseg√∫rese de que est√© habilitado y de que no haya otras extensiones de billetera que causen conflicto. Recuerde activar "Permitir en inc√≥gnito" para MetaMask si usa este modo.';
                    console.error("DEBUG: MetaMask no detectado despu√©s de varios intentos. window.ethereum es:", window.ethereum);
                    disableAllButtons();
                    updateConnectButtonStatus('error'); // Actualizar bot√≥n a "Desconectado/Error"
                    return;
                }
                console.log(`DEBUG: Intento ${attempts + 1}/${maxAttempts}: MetaMask no detectado. Reintentando en ${retryDelay}ms...`);
                await new Promise(resolve => setTimeout(resolve, retryDelay));
                attempts++;
            }

            console.log("DEBUG: MetaMask (window.ethereum) detectado.");

            // Paso 2: Manejar m√∫ltiples proveedores (si aplica, priorizar MetaMask)
            if (window.ethereum.providers && window.ethereum.providers.length > 1) {
                const metamaskProvider = window.ethereum.providers.find((provider) => provider.isMetaMask);
                if (metamaskProvider) {
                    window.ethereum = metamaskProvider; // Establecer MetaMask como el proveedor primario
                    console.log("DEBUG: M√∫ltiples proveedores detectados, priorizando MetaMask.");
                } else {
                    errorMessage.textContent = 'M√∫ltiples billeteras detectadas. Por favor, deshabilite otras extensiones de billetera excepto MetaMask.';
                    walletStatus.textContent = 'Error: Billeteras en conflicto.';
                    console.error("DEBUG: M√∫ltiples billeteras en conflicto, MetaMask no es el proveedor primario.");
                    disableAllButtons();
                    updateConnectButtonStatus('error');
                    return;
                }
            }

            try {
                // Paso 3: Inicializar Web3 con el proveedor de MetaMask
                web3 = new Web3(window.ethereum);
                console.log("DEBUG: Web3 inicializado con window.ethereum.");

                // Paso 4: Solicitar acceso a las cuentas
                console.log("DEBUG: Solicitando acceso a las cuentas de MetaMask...");
                const accountsFromMetaMask = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                if (accountsFromMetaMask.length === 0) {
                    walletStatus.textContent = 'Ninguna cuenta conectada.';
                    accountAddressElem.textContent = '';
                    errorMessage.textContent = 'Por favor, conecte una cuenta en MetaMask.';
                    console.warn("DEBUG: No se devolvieron cuentas de MetaMask.");
                    disableAllButtons();
                    updateConnectButtonStatus('disconnected');
                    return;
                }

                currentAccount = window.ethereum.selectedAddress || accountsFromMetaMask[0];
                accountAddressElem.textContent = `Cuenta Conectada: ${currentAccount}`;
                
                // Paso 5: Instanciar contratos
                stakingContract = new web3.eth.Contract(STAKING_CONTRACT_ABI, STAKING_CONTRACT_ADDRESS);
                oroBitTokenContract = new web3.eth.Contract(OROBIT_TOKEN_ABI, OROBIT_TOKEN_ADDRESS);
                console.log("DEBUG: Contratos de staking y token instanciados.");

                // Paso 6: Verificar y cambiar la red si es necesario
                const currentChainId = await web3.eth.getChainId();
                console.log("DEBUG: Chain ID actual:", currentChainId, "Expected:", parseInt(BNB_TESTNET_CHAIN_ID, 16));

                if (currentChainId !== parseInt(BNB_TESTNET_CHAIN_ID, 16)) {
                    console.log("DEBUG: Red incorrecta. Intentando cambiar a BNB Testnet.");
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: BNB_TESTNET_CHAIN_ID }],
                        });
                        walletStatus.textContent = '¬°MetaMask Conectado! (Red cambiada a BNB Testnet)'; // Actualiza aqu√≠
                        console.log("DEBUG: Red cambiada con √©xito.");
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            console.log("DEBUG: Red no a√±adida. Intentando a√±adirla.");
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: BNB_TESTNET_CHAIN_ID,
                                        chainName: 'BNB Smart Chain Testnet',
                                        rpcUrls: [BNB_TESTNET_RPC_URL],
                                        nativeCurrency: { name: 'BNB', symbol: 'tBNB', decimals: 18 },
                                        blockExplorerUrls: ['https://testnet.bscscan.com/'],
                                    }],
                                });
                                walletStatus.textContent = '¬°MetaMask Conectado! (Red a√±adida y cambiada a BNB Testnet)'; // Actualiza aqu√≠
                                console.log("DEBUG: Red a√±adida y cambiada con √©xito.");
                            } catch (addError) {
                                console.error('Error al a√±adir la red:', addError);
                                walletStatus.textContent = '¬°Advertencia! No se pudo a√±adir/cambiar a BNB Smart Chain Testnet.';
                                errorMessage.textContent = `Error: ${addError.message}`;
                                disableAllButtons();
                                updateConnectButtonStatus('error');
                                return;
                            }
                        } else {
                            console.error('Error al cambiar la red:', switchError);
                            walletStatus.textContent = '¬°Advertencia! No se pudo cambiar a BNB Smart Chain Testnet.';
                            errorMessage.textContent = `Error: ${switchError.message}`;
                            disableAllButtons();
                                updateConnectButtonStatus('error');
                            return;
                        }
                    }
                } else {
                    walletStatus.textContent = '¬°MetaMask Conectado!'; // Mensaje por defecto si la red ya es correcta
                }
                
                // Paso 7: Verificar si es la cuenta del propietario (despu√©s de que los contratos est√©n instanciados)
                const contractOwner = await stakingContract.methods.owner().call();
                isOwner = (currentAccount.toLowerCase() === OWNER_WALLET_ADDRESS.toLowerCase());
                console.log("DEBUG: Es propietario:", isOwner);

                // Mensaje de conexi√≥n din√°mico final para walletStatus
                if (isOwner) {
                    walletStatus.textContent = `¬°MetaMask Conectado! (Conectado como Propietario)`;
                }
                // Limpiar errorMessage aqu√≠ si no hay un error real
                errorMessage.textContent = '';
                
                if (isOwner) {
                    adminTab.style.display = 'block';
                } else {
                    adminTab.style.display = 'none';
                }

                // Paso 8: Cargar datos y habilitar botones
                loadDashboardData();
                loadPoolsForStaking();
                enableButtonsIfConnected();
                updateConnectButtonStatus('connected'); // Actualizar bot√≥n a "Conectado"
                console.log("DEBUG: Finalizada la conexi√≥n y carga de datos iniciales.");

            } catch (error) {
                console.error('Error general al conectar MetaMask:', error);
                walletStatus.textContent = 'Error al conectar MetaMask.';
                errorMessage.textContent = `Error: ${error.message}`;
                disableAllButtons();
                updateConnectButtonStatus('error'); // Actualizar bot√≥n a "Error"
            }
        }

        // --- Manejo de Eventos de MetaMask ---
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (newAccounts) => {
                console.log("DEBUG: accountsChanged event. Nuevas cuentas:", newAccounts);
                if (newAccounts.length > 0) {
                    currentAccount = newAccounts[0];
                    accountAddressElem.textContent = `Cuenta Conectada: ${currentAccount}`;
                    // Recargar toda la l√≥gica de conexi√≥n para asegurar el estado correcto
                    connectWallet(); 
                } else {
                    currentAccount = null;
                    accountAddressElem.textContent = 'Ninguna cuenta conectada.';
                    walletStatus.textContent = 'Por favor, conecte MetaMask.';
                    disableAllButtons();
                    adminTab.style.display = 'none';
                    resetDashboardData();
                    updateConnectButtonStatus('disconnected');
                    console.log("DEBUG: Cuentas cambiadas: ninguna cuenta conectada.");
                }
            });

            window.ethereum.on('chainChanged', async (chainId) => {
                console.log("DEBUG: chainChanged event. Nuevo Chain ID:", chainId);
                // Recargar toda la l√≥gica de conexi√≥n para asegurar el estado correcto
                connectWallet();
            });
        }


        // --- L√≥gica de Habilitaci√≥n/Deshabilitaci√≥n de Botones ---
        function disableAllButtons() {
            approveStakeBtn.disabled = true;
            stakeBtn.disabled = true;
            executeWithdrawBtn.disabled = true;
            addPoolBtn.disabled = true;
            setPoolStatusBtn.disabled = true;
            depositRewardsBtn.disabled = true;
            setEarlyWithdrawPenaltyBtn.disabled = true;
            quickAddPoolBtn.disabled = true; // Deshabilitar el bot√≥n r√°pido
            maxStakeAmountBtn.disabled = true; // Deshabilitar el bot√≥n MAX
            console.log("DEBUG: Todos los botones deshabilitados.");
        }

        function enableButtonsIfConnected() {
            if (currentAccount && stakingContract && oroBitTokenContract) {
                approveStakeBtn.disabled = false;
                executeWithdrawBtn.disabled = false;
                maxStakeAmountBtn.disabled = false; // Habilitar el bot√≥n MAX
                console.log("DEBUG: Botones de usuario (stake, withdraw) HABILITADOS.");
                console.log("DEBUG: Estado actual de executeWithdrawBtn.disabled:", executeWithdrawBtn.disabled);


                if (isOwner) {
                    addPoolBtn.disabled = false;
                    setPoolStatusBtn.disabled = false;
                    depositRewardsBtn.disabled = false;
                    setEarlyWithdrawPenaltyBtn.disabled = false;
                    quickAddPoolBtn.disabled = false; // Habilitar el bot√≥n r√°pido para el propietario
                    console.log("DEBUG: Botones de Admin HABILITADOS.");
                } else {
                    addPoolBtn.disabled = true;
                    setPoolStatusBtn.disabled = true;
                    depositRewardsBtn.disabled = true;
                    setEarlyWithdrawPenaltyBtn.disabled = true;
                    quickAddPoolBtn.disabled = true; // Deshabilitar el bot√≥n r√°pido si no es propietario
                    console.log("DEBUG: Botones de Admin deshabilitados (no propietario).");
                }
            } else {
                disableAllButtons();
                console.log("DEBUG: Cuentas/Contratos no listos, botones deshabilitados.");
            }
        }

        // --- Funciones de Carga de Datos del Dashboard ---
        async function loadDashboardData() {
            if (!currentAccount || !stakingContract || !oroBitTokenContract) {
                resetDashboardData();
                return;
            }
            console.log("DEBUG: loadDashboardData: Cargando datos del dashboard para", currentAccount);
            // Cargar balance de OroBit del usuario
            try {
                const balanceWei = await oroBitTokenContract.methods.balanceOf(currentAccount).call();
                currentUserOrobitBalance = fromWei(balanceWei); // Almacenar el saldo
                userOrobitBalanceElem.textContent = `${currentUserOrobitBalance} OROBIT`;
                console.log("DEBUG: Saldo de OroBit del usuario cargado:", currentUserOrobitBalance);
            } catch (error) {
                console.error("Error cargando el balance de OroBit:", error);
                userOrobitBalanceElem.textContent = "Error al cargar el saldo.";
                errorMessage.textContent = `Error al cargar el balance de OroBit: ${error.message}`;
            }

            // Cargar stakes del usuario
            try {
                const userStakesLength = await stakingContract.methods.getUserStakesLength(currentAccount).call();
                userTotalStakesElem.textContent = `${userStakesLength} stakes`;
                userStakesListElem.innerHTML = ''; // Limpiar lista anterior
                console.log("DEBUG: Total de stakes del usuario:", userStakesLength);

                if (userStakesLength > 0) {
                    for (let i = 0; i < userStakesLength; i++) {
                        try { // Added try-catch for individual stake loading
                            const stake = await stakingContract.methods.getUserStake(currentAccount, i).call();
                            let reward = "0"; // Default to 0 for display
                            // Solo calcular la recompensa si el stake no ha sido retirado
                            if (!stake.withdrawn) {
                                reward = await stakingContract.methods.calculateReward(currentAccount, i).call();
                            }
                            
                            const stakeItem = document.createElement('div');
                            stakeItem.className = 'bg-gray-800 bg-opacity-40 p-3 rounded-md text-gray-200';
                            
                            let statusText = stake.withdrawn ? '<span class="text-red-400">Retirado</span>' : '<span class="text-green-400">Activo</span>';
                            
                            const startTime = new Date(parseInt(stake.startTime) * 1000).toLocaleString();
                            const endTime = stake.duration > 0 ? new Date((parseInt(stake.startTime) + parseInt(stake.duration)) * 1000).toLocaleString() : 'N/A';
                            
                            stakeItem.innerHTML = `
                                <p class="font-semibold">ID: ${i} (${statusText})</p>
                                <p>Cantidad: ${fromWei(stake.amount)} OROBIT</p>
                                <p>APR: ${stake.aprBP / 100}%</p>
                                <p>Inicio: ${startTime}</p>
                                ${stake.isFlexible ? `<p>Tipo: Flexible</p>` : `<p>Duraci√≥n: ${stake.duration / (24 * 60 * 60)} d√≠as</p><p>Fin: ${endTime}</p>`}
                                <p>Recompensa Acumulada: ${fromWei(reward)} OROBIT</p>
                            `;
                            userStakesListElem.appendChild(stakeItem);
                            console.log(`DEBUG: Stake ${i} cargado:`, stake);
                        } catch (stakeError) {
                            console.error(`Error al cargar el stake ID ${i} para el usuario ${currentAccount}:`, stakeError);
                            const errorItem = document.createElement('div');
                            errorItem.className = 'bg-red-900 bg-opacity-40 p-3 rounded-md text-red-300';
                            errorItem.textContent = `Error cargando stake ID ${i}: ${decodeRevertReason(stakeError.data) || stakeError.message.substring(0, Math.min(stakeError.message.length, 100))}...`;
                            userStakesListElem.appendChild(errorItem);
                        }
                    }
                } else {
                    userStakesListElem.innerHTML = '<p class="text-center text-gray-400">No tiene stakes activos.</p>';
                }

            } catch (error) {
                console.error("Error cargando los stakes del usuario:", error);
                userTotalStakesElem.textContent = "Error al cargar stakes.";
                errorMessage.textContent = `Error al cargar sus stakes: ${error.message}`;
                userStakesListElem.innerHTML = '<p class="text-red-400 text-center">Error al cargar sus stakes. Revise la consola.</p>';
            }
        }

        function resetDashboardData() {
            userOrobitBalanceElem.textContent = 'N/A';
            userTotalStakesElem.textContent = 'N/A';
            userStakesListElem.innerHTML = '';
            console.log("DEBUG: Datos del dashboard reseteados.");
        }

        // --- L√≥gica de Staking ---
        // Nuevo manejador para el bot√≥n MAX
        maxStakeAmountBtn.addEventListener('click', () => {
            if (currentUserOrobitBalance !== '0') {
                stakeAmountInput.value = currentUserOrobitBalance;
            } else {
                stakeAmountInput.value = 0;
            }
        });

        async function loadPoolsForStaking() {
            if (!stakingContract) {
                poolSelect.innerHTML = '<option value="" disabled>Error al cargar pools.</option>';
                console.error("DEBUG: loadPoolsForStaking: stakingContract no definido.");
                // Mostrar el mensaje de no pools si el contrato no est√° listo
                if (isOwner) {
                    noPoolsMessage.classList.remove('hidden');
                } else {
                    noPoolsMessage.classList.add('hidden');
                }
                return;
            }
            console.log("DEBUG: loadPoolsForStaking: Cargando pools...");
            
            let poolLength = 0;
            let poolsFound = false; // Bandera para saber si se encontraron pools activos
            try {
                // CORRECCI√ìN CLAVE: Usar el nombre de funci√≥n correcto: getStakingPoolsLength()
                poolLength = await stakingContract.methods.getStakingPoolsLength().call(); 
                console.log("DEBUG: N√∫mero de pools detectados:", poolLength);
            } catch (error) {
                console.error("Error al obtener la longitud de los pools:", error);
                poolSelect.innerHTML = '<option value="" disabled selected>Error al cargar pools: No se pudo obtener la longitud.</option>';
                errorMessage.textContent = `Error al cargar pools de staking: No se pudo obtener la longitud de los pools. ${error.message}`;
                // Mostrar el mensaje de no pools si la longitud no se puede obtener y es propietario
                if (isOwner) {
                    noPoolsMessage.classList.remove('hidden');
                } else {
                    noPoolsMessage.classList.add('hidden');
                }
                return; // Salir si no se puede obtener la longitud
            }

            poolSelect.innerHTML = '<option value="" disabled selected>Seleccione un pool...</option>'; // Reiniciar

            const uniquePools = {}; // Usar un objeto para almacenar pools √∫nicos por sus caracter√≠sticas
            if (poolLength > 0) {
                for (let i = 0; i < poolLength; i++) {
                    try { // Added try-catch for individual pool loading
                        const pool = await stakingContract.methods.getPool(i).call();
                        if (pool.isActive) {
                            const durationText = pool.isFlexible ? 'Flexible' : `${pool.duration / (24 * 60 * 60)} d√≠as`;
                            const poolKey = `${durationText}-${pool.aprBP / 100}%`; // Clave √∫nica para el pool
                            
                            if (!uniquePools[poolKey]) {
                                uniquePools[poolKey] = {
                                    duration: pool.duration,
                                    aprBP: pool.aprBP,
                                    isFlexible: pool.isFlexible,
                                    ids: [i] // Guardar el primer ID encontrado
                                };
                            } else {
                                uniquePools[poolKey].ids.push(i); // A√±adir IDs adicionales si el pool es id√©ntico
                            }
                            poolsFound = true; // Se encontr√≥ al menos un pool activo
                            console.log(`DEBUG: Pool ${i} cargado:`, pool);
                        }
                    } catch (poolError) {
                        console.error(`Error al cargar el pool ID ${i}:`, poolError);
                        // No a√±adimos opciones de error al select, solo logueamos.
                    }
                }
            }
            
            // A√±adir las opciones √∫nicas al select
            if (poolsFound) {
                for (const key in uniquePools) {
                    const poolData = uniquePools[key];
                    const option = document.createElement('option');
                    // Mostrar todos los IDs para la transparencia, o elegir solo el primero
                    option.value = poolData.ids[0]; // Usar el primer ID para el valor
                    let idText = poolData.ids.length > 1 ? `IDs: ${poolData.ids.join(', ')}` : `ID: ${poolData.ids[0]}`;
                    option.textContent = `${idText} | Tipo: ${key.split('-')[0]} | APR: ${key.split('-')[1]}`;
                    poolSelect.appendChild(option);
                }
                noPoolsMessage.classList.add('hidden'); // Ocultar si hay pools
            } else { // Si no se encontraron pools activos
                poolSelect.innerHTML = '<option value="" disabled selected>No hay pools activos o disponibles.</option>';
                console.log("DEBUG: No hay pools activos para mostrar.");
                if (isOwner) { // Mostrar el mensaje de no pools si es propietario
                    noPoolsMessage.classList.remove('hidden');
                } else {
                    noPoolsMessage.classList.add('hidden');
                }
            }
        }

        approveStakeBtn.addEventListener('click', async () => {
            resetMessages();
            if (!currentAccount) {
                errorMessage.textContent = 'Por favor, conecte su MetaMask primero.';
                return;
            }
            const amount = stakeAmountInput.value;
            if (isNaN(amount) || parseFloat(amount) <= 0) {
                errorMessage.textContent = 'Por favor, introduzca una cantidad v√°lida para stakear.';
                return;
            }

            statusMessage.textContent = 'Aprobando tokens para staking...';
            try {
                const amountWei = toWei(amount);
                const tx = await oroBitTokenContract.methods.approve(STAKING_CONTRACT_ADDRESS, amountWei).send({ from: currentAccount });
                statusMessage.textContent = `Aprobaci√≥n Exitosa! Hash: ${tx.transactionHash}`;
                txHashElem.textContent = `Hash de Transacci√≥n: ${tx.transactionHash}`;
                stakeBtn.disabled = false; // Habilitar el bot√≥n de stake
            } catch (error) {
                console.error('Error al aprobar tokens:', error);
                statusMessage.textContent = 'Error al aprobar tokens.';
                errorMessage.textContent = `Error: ${error.message}. Revise MetaMask.`;
            }
        });

        stakeBtn.addEventListener('click', async () => {
            resetMessages();
            if (!currentAccount) {
                errorMessage.textContent = 'Por favor, conecte su MetaMask primero.';
                return;
            }
            const poolId = poolSelect.value;
            const amount = stakeAmountInput.value;

            if (!poolId) {
                errorMessage.textContent = 'Por favor, seleccione un pool de staking.';
                return;
            }
            if (isNaN(amount) || parseFloat(amount) <= 0) {
                errorMessage.textContent = 'Por favor, introduzca una cantidad v√°lida para stakear.';
                return;
            }

            statusMessage.textContent = 'Enviando transacci√≥n de stake...';
            try {
                const amountWei = toWei(amount);
                const tx = await stakingContract.methods.stake(parseInt(poolId), amountWei).send({ from: currentAccount });
                statusMessage.textContent = `Stake Exitoso! Hash: ${tx.transactionHash}`;
                txHashElem.textContent = `Hash de Transacci√≥n: ${tx.transactionHash}`;
                // Actualizar dashboard despu√©s de un stake exitoso
                await loadDashboardData();
            }
            catch (error) {
                console.error('Error al stakear tokens:', error);
                statusMessage.textContent = 'Error al stakear tokens.';
                errorMessage.textContent = `Error: ${error.message}. Revise MetaMask.`;
            }
        });

        // --- L√≥gica de Retiro ---
        executeWithdrawBtn.addEventListener('click', async () => {
            console.log("DEBUG: Bot√≥n 'Retirar Stake' (executeWithdrawBtn) clickeado."); // Debugging: log al inicio del manejador
            resetMessages();
            if (!currentAccount) {
                errorMessage.textContent = 'Por favor, conecte su MetaMask primero.';
                console.error("DEBUG: Retiro: currentAccount no est√° definido."); // Debugging: Error si la cuenta no est√°
                return;
            }

            console.log("DEBUG: Cuenta actual:", currentAccount); // Debugging: Muestra la cuenta actual
            console.log("DEBUG: Contrato de Staking:", stakingContract); // Debugging: Muestra el objeto del contrato de staking
            console.log("DEBUG: Contrato del Token OroBit:", oroBitTokenContract); // Debugging: Muestra el objeto del contrato del token

            const stakeId = parseInt(withdrawStakeIdInput.value);
            if (isNaN(stakeId)) {
                errorMessage.textContent = 'Por favor, introduzca un ID de stake v√°lido.';
                console.error("DEBUG: Retiro: ID de stake no v√°lido:", withdrawStakeIdInput.value); // Debugging: Error si el ID no es v√°lido
                return;
            }

            statusMessage.textContent = 'Preparando transacci√≥n de retiro...';
            try {
                console.log("DEBUG: Intentando enviar transacci√≥n de retiro para stakeId:", stakeId); // Debugging: Log antes de enviar la transacci√≥n
                const tx = await stakingContract.methods.withdraw(stakeId).send({ from: currentAccount });
                statusMessage.textContent = `¬°Transacci√≥n de Retiro Exitosa!`;
                txHashElem.textContent = `Hash de Transacci√≥n: ${tx.transactionHash}`;
                console.log("DEBUG: Transacci√≥n de retiro exitosa. Hash:", tx.transactionHash); // Debugging: Log si la transacci√≥n es exitosa
                // Actualizar dashboard despu√©s de un retiro exitoso
                await loadDashboardData();
            } catch (error) {
                console.error('DEBUG: Error al enviar la transacci√≥n de retiro:', error); // Debugging: Log del error
                statusMessage.textContent = 'Error al enviar la transacci√≥n de retiro.';
                errorMessage.textContent = `Error: ${error.message}. Por favor, revise MetaMask.`;
                // Intentar obtener la raz√≥n de revert m√°s detallada
                if (error.code === -32000 || error.code === 3) {
                    try {
                        const transactionParameters = {
                            to: STAKING_CONTRACT_ADDRESS,
                            from: currentAccount,
                            data: web3.eth.abi.encodeFunctionCall({
                                name: "withdraw",
                                type: "function",
                                inputs: [{ internalType: "uint256", name: "_stakeId", type: "uint256" }]
                            }, [stakeId])
                        };
                        console.log("DEBUG: Intentando eth_call para la raz√≥n de revert con params:", transactionParameters); // Debugging: Log antes de eth_call
                        const callResult = await web3.eth.call(transactionParameters);
                        if (callResult && callResult !== '0x') {
                            errorMessage.textContent += ` ${decodeRevertReason(callResult)}`;
                        } else {
                            errorMessage.textContent += ' (No se pudo obtener la raz√≥n exacta de la reversi√≥n.)';
                        }
                    } catch (callError) {
                        console.warn("DEBUG: No se pudo obtener la raz√≥n de reversi√≥n con eth_call:", callError); // Debugging: Log si eth_call falla
                        errorMessage.textContent += ' (No se pudo obtener la raz√≥n exacta de la reversi√≥n.)';
                    }
                }
            }
        });

        // --- L√≥gica de Administraci√≥n (Solo Propietario) ---
        addPoolBtn.addEventListener('click', async () => {
            resetMessages();
            if (!currentAccount || !isOwner) {
                errorMessage.textContent = 'Acceso denegado: solo el propietario puede a√±adir pools.';
                return;
            }
            const duration = parseInt(adminPoolDuration.value);
            const aprBP = parseInt(adminPoolAprBP.value);
            const isFlexible = adminPoolIsFlexible.checked;

            if (isNaN(duration) || isNaN(aprBP) || aprBP < 0 || aprBP > 100000) {
                errorMessage.textContent = 'Por favor, introduzca valores v√°lidos para el pool (APR entre 0 y 100000).';
                return;
            }

            statusMessage.textContent = 'A√±adiendo nuevo pool...';
            try {
                const tx = await stakingContract.methods.addPool(duration, aprBP, isFlexible).send({ from: currentAccount });
                statusMessage.textContent = `Pool a√±adido exitosamente! Hash: ${tx.transactionHash}`;
                txHashElem.textContent = `Hash de Transacci√≥n: ${tx.transactionHash}`;
                await loadPoolsForStaking(); // Recargar la lista de pools
            } catch (error) {
                console.error('Error al a√±adir pool:', error);
                statusMessage.textContent = 'Error al a√±adir pool.';
                errorMessage.textContent = `Error: ${error.message}. Revise MetaMask.`;
            }
        });

        // Nuevo manejador para el bot√≥n "A√±adir Pool R√°pido" en el dashboard
        quickAddPoolBtn.addEventListener('click', async () => {
            resetMessages();
            if (!currentAccount || !isOwner) {
                errorMessage.textContent = 'Acceso denegado: solo el propietario puede a√±adir pools.';
                return;
            }
            const duration = parseInt(quickAddPoolDuration.value);
            const aprBP = parseInt(quickAddPoolAprBP.value);
            const isFlexible = quickAddPoolIsFlexible.checked;

            if (isNaN(duration) || isNaN(aprBP) || aprBP < 0 || aprBP > 100000) {
                errorMessage.textContent = 'Por favor, introduzca valores v√°lidos para el pool (APR entre 0 y 100000).';
                return;
            }

            statusMessage.textContent = 'A√±adiendo nuevo pool r√°pido...';
            try {
                const tx = await stakingContract.methods.addPool(duration, aprBP, isFlexible).send({ from: currentAccount });
                statusMessage.textContent = `Pool a√±adido exitosamente! Hash: ${tx.transactionHash}`;
                txHashElem.textContent = `Hash de Transacci√≥n: ${tx.transactionHash}`;
                await loadPoolsForStaking(); // Recargar la lista de pools
                // Ocultar el mensaje de no pools despu√©s de a√±adir uno
                noPoolsMessage.classList.add('hidden');
            } catch (error) {
                console.error('Error al a√±adir pool r√°pido:', error);
                statusMessage.textContent = 'Error al a√±adir pool r√°pido.';
                errorMessage.textContent = `Error: ${error.message}. Revise MetaMask.`;
            }
        });


        setPoolStatusBtn.addEventListener('click', async () => {
            resetMessages();
            if (!currentAccount || !isOwner) {
                errorMessage.textContent = 'Acceso denegado: solo el propietario puede cambiar el estado del pool.';
                return;
            }
            const poolId = parseInt(adminSetPoolId.value);
            const isActive = adminSetPoolActive.checked;

            if (isNaN(poolId) || poolId < 0) {
                errorMessage.textContent = 'Por favor, introduzca un ID de pool v√°lido.';
                return;
            }

            statusMessage.textContent = 'Actualizando estado del pool...';
            try {
                const tx = await stakingContract.methods.setPoolStatus(poolId, isActive).send({ from: currentAccount });
                statusMessage.textContent = `Estado del pool actualizado! Hash: ${tx.transactionHash}`;
                txHashElem.textContent = `Hash de Transacci√≥n: ${tx.transactionHash}`;
                await loadPoolsForStaking(); // Recargar la lista de pools
                await loadDashboardData(); // Refrescar dashboard por si afecta a stakes activos
            } catch (error) {
                console.error('Error al actualizar estado del pool:', error);
                statusMessage.textContent = 'Error al actualizar estado del pool.';
                errorMessage.textContent = `Error: ${error.message}. Revise MetaMask.`;
            }
        });

        depositRewardsBtn.addEventListener('click', async () => {
            resetMessages();
            if (!currentAccount || !isOwner) {
                errorMessage.textContent = 'Acceso denegado: solo el propietario puede depositar recompensas.';
                return;
            }
            const amount = depositRewardsAmount.value;
            if (isNaN(amount) || parseFloat(amount) <= 0) {
                errorMessage.textContent = 'Por favor, introduzca una cantidad v√°lida para depositar.';
                return;
            }

            statusMessage.textContent = 'Aprobando tokens para dep√≥sito de recompensas...';
            try {
                const amountWei = toWei(amount);
                // Primero, aprobar al contrato de staking para que tome los tokens del propietario
                await oroBitTokenContract.methods.approve(STAKING_CONTRACT_ADDRESS, amountWei).send({ from: currentAccount });
                
                statusMessage.textContent = 'Depositando recompensas...';
                // Luego, llamar a depositRewards en el contrato de staking
                const tx = await stakingContract.methods.depositRewards(amountWei).send({ from: currentAccount });
                statusMessage.textContent = `Recompensas depositadas exitosamente! Hash: ${tx.transactionHash}`;
                txHashElem.textContent = `Hash de Transacci√≥n: ${tx.transactionHash}`; 
                await loadDashboardData(); // Actualizar balance del contrato de staking en el dashboard
            } catch (error) {
                console.error('Error al depositar recompensas:', error);
                statusMessage.textContent = 'Error al depositar recompensas.';
                errorMessage.textContent = `Error: ${error.message}. Revise MetaMask.`;
            }
        });

        setEarlyWithdrawPenaltyBtn.addEventListener('click', async () => {
            resetMessages();
            if (!currentAccount || !isOwner) {
                errorMessage.textContent = 'Acceso denegado: solo el propietario puede establecer la penalizaci√≥n.';
                return;
            }
            const penaltyBP = parseInt(earlyWithdrawPenaltyBP.value);
            if (isNaN(penaltyBP) || penaltyBP < 0 || penaltyBP > 10000) {
                errorMessage.textContent = 'Por favor, introduzca una penalizaci√≥n v√°lida (0-10000 Basis Points).';
                return;
            }

            statusMessage.textContent = 'Estableciendo penalizaci√≥n por retiro anticipado...';
            try {
                const tx = await stakingContract.methods.setEarlyWithdrawPenalty(penaltyBP).send({ from: currentAccount });
                statusMessage.textContent = `Penalizaci√≥n establecida! Hash: ${tx.transactionHash}`;
                txHashElem.textContent = `Hash de Transacci√≥n: ${tx.transactionHash}`; 
            } catch (error) {
                console.error('Error al establecer la penalizaci√≥n:', error);
                statusMessage.textContent = 'Error al establecer la penalizaci√≥n.';
                errorMessage.textContent = `Error: ${error.message}. Revise MetaMask.`;
            }
        });


        // --- L√≥gica de Pesta√±as (Tabs) ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Eliminar 'active' de todos los botones y contenidos
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                // A√±adir 'active' al bot√≥n y contenido actuales
                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');

                // Recargar datos si es el dashboard
                if (button.dataset.tab === 'dashboard-tab') {
                    loadDashboardData();
                } else if (button.dataset.tab === 'stake-tab') {
                    loadPoolsForStaking(); // Asegurarse de cargar pools al ir a la pesta√±a de stakear
                }
            });
        });

        // --- Inicializaci√≥n ---
        window.addEventListener('load', () => {
            // Conectar MetaMask al cargar la p√°gina
            connectWallet(); // Llamar a la funci√≥n de conexi√≥n al cargar
            
            // Configurar el enlace para adquirir OroBit
            acquireOrobitBtn.href = PANCAKESWAP_TESTNET_URL;
        });

    </script>
</body>
</html>
