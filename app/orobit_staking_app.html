<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OroBit Staking App</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Fondo oscuro */
            color: #e2e8f0; /* Texto claro */
        }
        .card {
            background-color: #2d3748; /* Fondo de tarjeta más claro */
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #6366f1; /* Morado */
            color: white;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #4f46e5; /* Morado más oscuro al pasar el ratón */
        }
        .input-field {
            background-color: #4a5568;
            border-color: #6366f1;
            color: white;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
        }
        .header {
            background-color: #4f46e5;
            padding: 1.5rem;
            border-bottom-left-radius: 1rem;
            border-bottom-right-radius: 1rem;
        }
        .nav-link {
            color: #cbd5e0;
            transition: color 0.3s ease;
        }
        .nav-link:hover {
            color: #e2e8f0;
        }

        /* Estilos para el modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #2d3748;
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 500px;
            text-align: center;
            color: #e2e8f0;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: white;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8">

    <!-- Header Section -->
    <header class="header w-full text-center mb-8">
        <h1 class="text-4xl font-bold text-white mb-2">OroBit Staking</h1>
        <p class="text-lg text-white">¡Staking de próxima generación para OroBitverse!</p>
        <nav class="mt-4">
            <a href="index.html" class="nav-link mx-2">Inicio</a>
            <a href="whitepaper.html" class="nav-link mx-2">White Paper</a>
            <a href="orobit_staking_app.html" class="nav-link mx-2">Staking App</a>
        </nav>
    </header>

    <main class="w-full max-w-4xl px-4 flex-grow">
        <!-- User ID Display -->
        <div id="userIdDisplay" class="card p-4 mb-6 text-center text-sm">
            Cargando ID de usuario...
        </div>

        <!-- Section: Staking Pools -->
        <section class="card p-6 mb-8">
            <h2 class="text-3xl font-bold text-center mb-6">Pools de Staking Disponibles</h2>
            <div id="stakingPools" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Pool cards will be injected here -->
                <div class="bg-gray-700 p-4 rounded-lg text-center">
                    <p class="text-gray-400">Cargando pools de staking...</p>
                </div>
            </div>
        </section>

        <!-- Section: My Stakes -->
        <section class="card p-6 mb-8">
            <h2 class="text-3xl font-bold text-center mb-6">Mis Stakes</h2>
            <div id="myStakes" class="grid grid-cols-1 gap-6">
                <!-- User's stakes will be injected here -->
                <div class="bg-gray-700 p-4 rounded-lg text-center">
                    <p class="text-gray-400">Cargando tus stakes...</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Message Modal -->
    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <p id="modalMessage" class="text-lg"></p>
            <button id="modalConfirmBtn" class="btn-primary mt-4 hidden" onclick="confirmAction()">Confirmar</button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importar las funciones necesarias de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances
        let app;
        let db;
        let auth;
        let userId = 'loading...'; // Initialize with a loading state

        // Initialize Firebase only once
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Ensure __firebase_config and __app_id are available
                const firebaseConfigRaw = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (!firebaseConfigRaw) {
                    console.error("Error: __firebase_config no está definido. Firebase no se inicializará.");
                    document.getElementById('userIdDisplay').textContent = 'Error: Configuración de Firebase no disponible. Funcionalidad limitada.';
                    showMessageModal('Error de configuración: La persistencia de datos no está disponible. Por favor, asegúrese de que la configuración de Firebase sea proporcionada por el entorno.');
                    return; // Exit if config is missing
                }

                const firebaseConfig = JSON.parse(firebaseConfigRaw);

                // Check if app is already initialized
                if (!app) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    console.log("Firebase initialized successfully.");
                } else {
                    console.log("Firebase already initialized.");
                }

                // Sign in with custom token or anonymously
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; // Firebase authenticated user ID
                        document.getElementById('userIdDisplay').textContent = `Tu ID de usuario: ${userId}`;
                        console.log(`User authenticated: ${userId}`);
                        // Now that we have userId, we can fetch/listen to Firestore data
                        // (This part will be replaced by Web3.js integration later)
                        // fetchPoolsAndStakes(); 
                    } else {
                        userId = crypto.randomUUID(); // Fallback for anonymous or unauthenticated users
                        document.getElementById('userIdDisplay').textContent = `Tu ID de sesión (anónimo): ${userId}`;
                        console.log(`No user authenticated, using anonymous ID: ${userId}`);
                        // fetchPoolsAndStakes(); 
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                document.getElementById('userIdDisplay').textContent = 'Error: No se pudo inicializar Firebase. Funcionalidad limitada.';
                showMessageModal(`Error crítico: ${error.message}. La aplicación no puede cargar datos.`);
            }
        });

        // --- Mock Data and Modal Functions (will be replaced by contract interaction) ---
        // Mock data structure for pools (for now, will come from contract later)
        const mockStakingPools = [
            { id: 0, duration: "Flexible", apr: "5%", isActive: true, isFlexible: true },
            { id: 1, duration: "30 Días", apr: "10%", isActive: true, isFlexible: false },
            { id: 2, duration: "90 Días", apr: "15%", isActive: true, isFlexible: false },
            { id: 3, duration: "180 Días", apr: "20%", isActive: true, isFlexible: false },
        ];

        // Functions for modal (already defined in previous versions)
        let resolveModalPromise;
        let rejectModalPromise;

        function showMessageModal(message, showConfirm = false) {
            const modal = document.getElementById('messageModal');
            document.getElementById('modalMessage').textContent = message;
            const confirmBtn = document.getElementById('modalConfirmBtn');
            if (showConfirm) {
                confirmBtn.classList.remove('hidden');
            } else {
                confirmBtn.classList.add('hidden');
            }
            modal.style.display = 'flex'; // Use flex to center
            return new Promise((resolve, reject) => {
                resolveModalPromise = resolve;
                rejectModalPromise = reject;
            });
        }

        function closeModal() {
            document.getElementById('messageModal').style.display = 'none';
            if (rejectModalPromise) {
                rejectModalPromise(new Error('Modal cerrado por el usuario.'));
                resolveModalPromise = null;
                rejectModalPromise = null;
            }
        }

        function confirmAction() {
            document.getElementById('messageModal').style.display = 'none';
            if (resolveModalPromise) {
                resolveModalPromise(true);
                resolveModalPromise = null;
                rejectModalPromise = null;
            }
        }

        // Render pools (mocked for now)
        function renderStakingPools() {
            const container = document.getElementById('stakingPools');
            container.innerHTML = ''; // Clear previous content

            mockStakingPools.forEach(pool => {
                const poolCard = `
                    <div class="card p-4 flex flex-col items-center">
                        <h3 class="text-xl font-semibold mb-2">${pool.duration}</h3>
                        <p class="text-lg text-indigo-300 mb-4">${pool.apr} APR</p>
                        ${pool.isActive ? `
                            <input type="number" id="stakeAmount-${pool.id}" placeholder="Cantidad de OroBit" class="input-field w-full mb-4 text-center">
                            <button onclick="handleStake(${pool.id})" class="btn-primary w-full">Stakear</button>
                        ` : `
                            <p class="text-red-400">Pool Inactivo</p>
                        `}
                    </div>
                `;
                container.innerHTML += poolCard;
            });
        }

        // Mock stake handler (will be replaced by actual contract call)
        async function handleStake(poolId) {
            const amountInput = document.getElementById(`stakeAmount-${poolId}`);
            const amount = parseFloat(amountInput.value);

            if (isNaN(amount) || amount <= 0) {
                await showMessageModal("Por favor, introduce una cantidad válida.");
                return;
            }

            try {
                await showMessageModal(`Confirmar staking de ${amount} OroBit en el pool ${mockStakingPools[poolId].duration}.`, true);
                // Simulate success
                await showMessageModal(`¡Staking de ${amount} OroBit exitoso en el pool ${mockStakingPools[poolId].duration}!`);
                amountInput.value = ''; // Clear input
                // In a real scenario, you'd refresh the user's stakes
            } catch (error) {
                if (error.message !== 'Modal cerrado por el usuario.') {
                    await showMessageModal(`Error al stakear: ${error.message}`);
                }
            }
        }

        // Mock render for user stakes (will be replaced by actual contract call)
        function renderMyStakes() {
            const container = document.getElementById('myStakes');
            container.innerHTML = `
                <div class="bg-gray-700 p-4 rounded-lg text-center">
                    <p class="text-gray-400">Tus stakes aparecerán aquí cuando la integración con el contrato de Mainnet esté completa.</p>
                    <p class="text-gray-400 mt-2">Actualmente, esta sección es para desarrollo.</p>
                </div>
            `;
            // This is where user's actual stakes from the contract would be listed
            // For now, it's a placeholder.
        }

        // Initial render calls
        renderStakingPools();
        renderMyStakes();

        // Expose functions to global scope for onclick events
        window.handleStake = handleStake;
        window.showMessageModal = showMessageModal;
        window.closeModal = closeModal;
        window.confirmAction = confirmAction;

        // Facebook SDK (already in your files)
        window.fbAsyncInit = function() {
            FB.init({
                appId      : '1259307742369036',
                xfbml      : true,
                version    : 'v12.0'
            });
            FB.AppEvents.logPageView();
        };

        (function(d, s, id){
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {return;}
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    </script>
</body>
</html>
