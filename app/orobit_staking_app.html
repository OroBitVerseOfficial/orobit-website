<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OroBit Staking: Invierte en Oro y Bitcoin</title>
    <!--
        Content Security Policy (CSP) para permitir el funcionamiento de la aplicación en entornos locales.
        ADVERTENCIA: 'unsafe-eval' y 'unsafe-inline' relajan la seguridad y NO deben usarse en producción.
        Se incluyen para la fase de desarrollo y pruebas locales.
    -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net;
        style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://fonts.googleapis.com;
        img-src 'self' https://placehold.co data:;
        connect-src 'self' https://data-seed-prebsc-1-s1.binance.org:8545/ https://bscscan.com https://testnet.bscscan.com/ https://pancakeswap.finance;
        font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com;
    ">
    
    <!-- Favicon de OroBit - Usando la imagen de tu logo -->
    <link rel="icon" href="../images/orobit_logo_1280x720.png" type="image/png">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-image: url('https://placehold.co/1920x1080/1a202c/e2e8f0?text=Circuito+Digital+Oro+Bitcoin'); /* Fondo temático */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .container {
            max-width: 800px; /* Un poco más grande para el nuevo contenido */
            background-color: rgba(255, 255, 255, 0.08); /* Fondo blanco con opacidad */
            backdrop-filter: blur(10px); /* Efecto de desenfoque detrás */
            border: 1px solid rgba(255, 255, 255, 0.1); /* Borde sutil */
            border-radius: 1.5rem; /* Bordes más redondeados */
            padding: 2.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.15); /* Sombra más pronunciada */
        }
        input, button, select {
            border-radius: 0.75rem; /* rounded-xl */
        }
        /* Estilos específicos para un mejor aspecto en móviles */
        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
                margin: 1rem;
            }
            h1 {
                font-size: 2rem;
            }
            h2 {
                font-size: 1.5rem;
            }
        }
        /* Estilo para las pestañas de navegación */
        .tab-button {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: #a78bfa; /* purple-300 */
        }
        .tab-button.active {
            border-color: #8b5cf6; /* purple-500 */
            color: #d8b4fe; /* purple-200 */
            background-color: rgba(139, 92, 246, 0.1); /* purple-500 con opacidad */
        }
        .tab-content {
            display: none;
            padding-top: 1.5rem;
        }
        .tab-content.active {
            display: block;
        }
        /* Estilo para los cards de pool */
        .pool-card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }
        /* Estilos para el encabezado de la app de staking */
        .staking-app-header {
            display: flex;
            align-items: center;
            justify-content: center; /* Centrar para pantallas pequeñas */
            margin-bottom: 1.5rem;
            flex-wrap: wrap; /* Permitir que los elementos se envuelvan en pantallas pequeñas */
            text-align: center;
        }
        .staking-app-header .logo-container {
            display: flex;
            align-items: center;
            margin-right: 1rem; /* Espacio entre logo y título */
        }
        @media (max-width: 640px) { /* Ajuste para móviles */
            .staking-app-header {
                flex-direction: column; /* Apilar elementos verticalmente */
            }
            .staking-app-header .logo-container {
                margin-right: 0;
                margin-bottom: 0.5rem; /* Espacio debajo del logo */
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-800 to-purple-900 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="container text-white">
        <!-- Encabezado de la Aplicación de Staking con Logo -->
        <div class="staking-app-header">
            <div class="logo-container">
                <img src="../images/orobit_logo_1280x720.png" alt="Logo de OroBit" class="h-10 rounded-lg shadow-lg mr-2"> <!-- Changed from rounded-full to rounded-lg -->
                <h1 class="text-4xl font-extrabold text-yellow-300 drop-shadow-lg">
                    OroBit Staking <i class="fas fa-gem ml-2 text-blue-400"></i>
                </h1>
            </div>
        </div>
        <p class="text-base text-center mb-8 text-gray-300">
            Invierte en Oro y Bitcoin: Sencillo. Seguro. Rentable.
        </p>

        <!-- Contrato de Staking de OroBit Address (Read-only) -->
        <div class="mb-4 text-center">
            <label for="stakingContractAddress" class="block text-sm font-medium text-indigo-300 mb-1">Contrato Inteligente:</label>
            <input type="text" id="stakingContractAddress" value="0x8278ebadbc25beea94d6370174b8eeb7b5bfd253" class="w-full p-2 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 text-center focus:outline-none focus:ring-2 focus:ring-purple-500" readonly>
            <p class="text-xs text-gray-400 mt-1">Conectado a la BNB Smart Chain Testnet</p>
        </div>

        <!-- Conexión a MetaMask -->
        <button id="connectWalletBtn" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
            <i class="fab fa-ethereum mr-2 text-lg"></i> Conectar MetaMask
        </button>
        <p id="walletStatus" class="text-center text-sm mt-3 text-indigo-300"></p>
        <p id="accountAddress" class="text-center text-xs mt-1 text-gray-400 break-all"></p>

        <hr class="border-t border-gray-700 my-8">

        <!-- Pestañas de Navegación -->
        <div class="flex justify-center mb-6 border-b border-gray-700">
            <button class="tab-button active" data-tab="dashboard-tab">
                <i class="fas fa-tachometer-alt mr-2"></i> Mi Dashboard
            </button>
            <button class="tab-button" data-tab="stake-tab">
                <i class="fas fa-hand-holding-usd mr-2"></i> Stakear
            </button>
            <button class="tab-button" data-tab="withdraw-tab">
                <i class="fas fa-coins mr-2"></i> Retirar
            </button>
            <button class="tab-button" data-tab="admin-tab">
                <i class="fas fa-user-shield mr-2"></i> Admin
            </button>
        </div>

        <!-- Contenido del Dashboard -->
        <div id="dashboard-tab" class="tab-content active">
            <h2 class="text-2xl font-bold mb-4 text-center text-yellow-200">📊 Mi Resumen de Staking</h2>
            <div class="space-y-4">
                <div class="pool-card">
                    <p class="text-indigo-300 font-semibold mb-2">Su Saldo de OroBit:</p>
                    <p id="userOrobitBalance" class="text-xl text-yellow-100"><i class="fas fa-spinner fa-spin mr-2"></i>Cargando...</p>
                </div>
                <div class="pool-card">
                    <p class="text-indigo-300 font-semibold mb-2">Total de sus Stakes Activos:</p>
                    <p id="userTotalStakes" class="text-xl text-yellow-100"><i class="fas fa-spinner fa-spin mr-2"></i>Cargando...</p>
                    <div id="userStakesList" class="mt-4 text-gray-300 text-sm space-y-2">
                        <!-- Los stakes del usuario se cargarán aquí -->
                    </div>
                </div>

                <!-- Sección para añadir un pool rápido si no hay -->
                <div id="noPoolsMessage" class="pool-card hidden">
                    <h3 class="text-xl font-bold mb-3 text-red-300"><i class="fas fa-exclamation-triangle mr-2"></i> ¡No hay Pools de Staking!</h3>
                    <p class="text-sm text-gray-300 mb-4">
                        Parece que no hay pools de staking activos. Como propietario, puede añadir uno desde aquí.
                    </p>
                    <div class="space-y-3">
                        <div>
                            <label for="quickAddPoolDuration" class="block text-sm font-medium text-indigo-300 mb-1">Duración (segundos, 0 para flexible):</label>
                            <input type="number" id="quickAddPoolDuration" value="2592000" min="0" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label for="quickAddPoolAprBP" class="block text-sm font-medium text-indigo-300 mb-1">APR (Basis Points, Ej. 500 para 5%):</label>
                            <input type="number" id="quickAddPoolAprBP" value="2000" min="0" max="100000" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="quickAddPoolIsFlexible" class="h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                            <label for="quickAddPoolIsFlexible" class="ml-2 block text-sm text-indigo-300">Es Flexible</label>
                        </div>
                        <button id="quickAddPoolBtn" class="w-full bg-purple-700 hover:bg-purple-800 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                            <i class="fas fa-plus-circle mr-2"></i> Añadir Pool Rápido
                        </button>
                    </div>
                </div>

                <!-- Nueva sección para adquirir OroBit -->
                <div class="pool-card">
                    <h3 class="text-xl font-bold mb-3 text-indigo-200"><i class="fas fa-coins mr-2"></i> ¿Necesita más OroBit?</h3>
                    <p class="text-sm text-gray-300 mb-4">
                        Adquiera tokens OroBit para comenzar a stakear y ganar recompensas.
                        Puede obtenerlos a través de intercambios descentralizados (DEX).
                        <span class="font-semibold text-yellow-300">¡Recuerde, aunque el token se llama "OroBit", el proyecto principal podría tener un nombre más distintivo en el futuro para evitar confusiones. ¡Estamos en Testnet!</span>
                    </p>
                    <a id="acquireOrobitBtn" href="#" target="_blank" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                        <i class="fas fa-exchange-alt mr-2"></i> Adquirir OroBit (PancakeSwap Testnet)
                    </a>
                    <p class="text-xs text-gray-400 mt-2 text-center">
                        Para operaciones en Testnet, use PancakeSwap Testnet. Para Mainnet, use la plataforma oficial.
                        <!-- Para incluir tu enlace de afiliado de PancakeSwap en Mainnet, modifica el 'href' de arriba. -->
                    </p>
                </div>

                <!-- Sección para enlaces de afiliados -->
                <div class="pool-card">
                    <h3 class="text-xl font-bold mb-3 text-indigo-200"><i class="fas fa-link mr-2"></i> Enlaces de Afiliados</h3>
                    <p class="text-sm text-gray-300 mb-4">
                        Regístrate o opera en nuestros exchanges afiliados y apoya el ecosistema OroBit.
                    </p>
                    <div class="flex flex-col space-y-3">
                        <a href="https://www.binance.com/referral/mystery-box/eu-rewardbox/claim?ref=GRO_18422_RAHG6" target="_blank" class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                            <i class="fas fa-coins mr-2"></i> Binance
                        </a>
                        <a href="https://www.kucoin.com/r/rf/CX8HVQCY" target="_blank" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-900 font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                            <i class="fas fa-coins mr-2"></i> KuCoin
                        </a>
                        <a href="https://advanced.coinbase.com/join/83MUVTN" target="_blank" class="w-full bg-blue-400 hover:bg-blue-500 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                            <i class="fas fa-coins mr-2"></i> Coinbase
                        </a>
                    </div>
                </div>

                <!-- Sección para la Comunidad - AGREGADO AQUÍ -->
                <div class="pool-card">
                    <h3 class="text-xl font-bold mb-3 text-indigo-200"><i class="fas fa-users mr-2"></i> Únete a Nuestra Comunidad</h3>
                    <p class="text-sm text-gray-300 mb-4">
                        Conéctate con otros entusiastas de OroBitverse en nuestras redes sociales. ¡Crece, aprende y contribuye!
                    </p>
                    <div class="flex flex-wrap justify-center gap-4 text-3xl">
                        <a href="https://www.youtube.com/OroBitverse" target="_blank" class="text-red-600 hover:text-red-700 transition duration-300 transform hover:scale-110" aria-label="YouTube">
                            <i class="fab fa-youtube"></i>
                        </a>
                        <a href="https://www.tiktok.com/@orobitverse.com" target="_blank" class="text-gray-400 hover:text-gray-300 transition duration-300 transform hover:scale-110" aria-label="TikTok">
                            <i class="fab fa-tiktok"></i>
                        </a>
                        <a href="https://www.instagram.com/orobitverse/" target="_blank" class="text-pink-500 hover:text-pink-600 transition duration-300 transform hover:scale-110" aria-label="Instagram">
                            <i class="fab fa-instagram"></i>
                        </a>
                        <a href="https://x.com/OroBitverse" target="_blank" class="text-blue-400 hover:text-blue-500 transition duration-300 transform hover:scale-110" aria-label="Twitter">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="https://www.facebook.com/orobitverse" target="_blank" class="text-blue-700 hover:text-blue-800 transition duration-300 transform hover:scale-110" aria-label="Facebook">
                            <i class="fab fa-facebook"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido de Stakear -->
        <div id="stake-tab" class="tab-content">
            <h2 class="text-2xl font-bold mb-4 text-center text-yellow-200">🚀 Stakear OroBit</h2>
            <div class="space-y-4">
                <div>
                    <label for="stakeAmountInput" class="block text-sm font-medium text-indigo-300 mb-1">
                        Cantidad a Stakear (OroBit):
                    </label>
                    <div class="relative flex">
                        <input type="number" id="stakeAmountInput" value="1" min="0.000000000000000001" step="0.000000000000000001" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500 pr-12">
                        <button id="maxStakeAmountBtn" class="absolute inset-y-0 right-0 flex items-center px-4 text-sm font-semibold text-purple-200 bg-purple-600 hover:bg-purple-700 rounded-r-lg transition duration-200 ease-in-out">
                            MAX
                        </button>
                    </div>
                </div>
                <div>
                    <label for="poolSelect" class="block text-sm font-medium text-indigo-300 mb-1">Seleccione un Pool:</label>
                    <select id="poolSelect" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="" disabled selected>Cargando pools...</option>
                    </select>
                </div>
                <button id="approveStakeBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                    <i class="fas fa-check-circle mr-2"></i> Aprobar Staking
                </button>
                <button id="stakeBtn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center" disabled>
                    <i class="fas fa-layer-group mr-2"></i> Confirmar Stake
                </button>
            </div>
        </div>

        <!-- Contenido de Retirar -->
        <div id="withdraw-tab" class="tab-content">
            <h2 class="text-2xl font-bold mb-4 text-center text-yellow-200">💸 Retirar OroBit</h2>
            <div class="space-y-4">
                <div>
                    <label for="withdrawStakeIdInput" class="block text-sm font-medium text-indigo-300 mb-1">ID del Stake a Retirar:</label>
                    <input type="number" id="withdrawStakeIdInput" value="0" min="0" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <button id="executeWithdrawBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center" disabled>
                    <i class="fas fa-wallet mr-2"></i> Retirar Stake
                </button>
            </div>
        </div>

        <!-- Contenido del Panel de Admin -->
        <div id="admin-tab" class="tab-content">
            <h2 class="text-2xl font-bold mb-4 text-center text-red-300">🛡️ Panel de Administración</h2>
            <p class="text-sm text-gray-400 mb-6 text-center">Solo visible para el propietario del contrato.</p>
            <div class="space-y-4">
                <div class="pool-card">
                    <h3 class="text-xl font-bold mb-2 text-indigo-200">Añadir Nuevo Pool de Staking</h3>
                    <div>
                        <label for="adminPoolDuration" class="block text-sm font-medium text-indigo-300 mb-1">Duración (segundos, 0 para flexible):</label>
                        <input type="number" id="adminPoolDuration" value="2592000" min="0" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label for="adminPoolAprBP" class="block text-sm font-medium text-indigo-300 mb-1">APR (Basis Points, Ej. 500 para 5%):</label>
                        <input type="number" id="adminPoolAprBP" value="2000" min="0" max="100000" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="adminPoolIsFlexible" class="h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                        <label for="adminPoolIsFlexible" class="ml-2 block text-sm text-indigo-300">Es Flexible</label>
                    </div>
                    <button id="addPoolBtn" class="w-full mt-4 bg-purple-700 hover:bg-purple-800 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                        <i class="fas fa-plus-circle mr-2"></i> Añadir Pool
                    </button>
                </div>

                <div class="pool-card">
                    <h3 class="text-xl font-bold mb-2 text-indigo-200">Actualizar Estado de Pool</h3>
                    <div>
                        <label for="adminSetPoolId" class="block text-sm font-medium text-indigo-300 mb-1">ID del Pool:</label>
                        <input type="number" id="adminSetPoolId" value="0" min="0" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="adminSetPoolActive" checked class="h-4 w-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                        <label for="adminSetPoolActive" class="ml-2 block text-sm text-indigo-300">Activo</label>
                    </div>
                    <button id="setPoolStatusBtn" class="w-full mt-4 bg-purple-700 hover:bg-purple-800 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                        <i class="fas fa-toggle-on mr-2"></i> Actualizar Estado
                    </button>
                </div>

                <div class="pool-card">
                    <h3 class="text-xl font-bold mb-2 text-indigo-200">Depositar Recompensas (OroBit)</h3>
                    <div>
                        <label for="depositRewardsAmount" class="block text-sm font-medium text-indigo-300 mb-1">Cantidad a Depositar:</label>
                        <input type="number" id="depositRewardsAmount" value="100" min="1" step="0.000000000000000001" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <button id="depositRewardsBtn" class="w-full mt-4 bg-purple-700 hover:bg-purple-800 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                        <i class="fas fa-hand-holding-heart mr-2"></i> Depositar
                    </button>
                </div>

                <div class="pool-card">
                    <h3 class="text-xl font-bold mb-2 text-indigo-200">Actualizar Penalización por Retiro Anticipado</h3>
                    <div>
                        <label for="earlyWithdrawPenaltyBP" class="block text-sm font-medium text-indigo-300 mb-1">Penalización (Basis Points, 0-10000):</label>
                        <input type="number" id="earlyWithdrawPenaltyBP" value="2000" min="0" max="10000" class="w-full p-3 bg-gray-700 bg-opacity-50 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <button id="setEarlyWithdrawPenaltyBtn" class="w-full mt-4 bg-purple-700 hover:bg-purple-800 text-white font-semibold py-3 px-6 rounded-xl transition duration-300 ease-in-out transform hover:scale-105 shadow-lg flex items-center justify-center">
                        <i class="fas fa-gavel mr-2"></i> Establecer Penalización
                    </button>
                </div>
            </div>
        </div>

        <!-- Área de Mensajes Global -->
        <div id="messageArea" class="mt-8 p-4 bg-gray-800 bg-opacity-50 rounded-lg text-gray-200 text-sm">
            <p id="statusMessage" class="font-semibold"></p>
            <p id="errorMessage" class="text-red-400 mt-2"></p>
            <p id="txHash" class="break-words mt-2"></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        // --- Configuraciones de la Blockchain ---
        const STAKING_CONTRACT_ADDRESS = "0x8278ebadbc25beea94d6370174b8eeb7b5bfd253"; // Contrato de Staking
        const OROBIT_TOKEN_ADDRESS = "0x8bC4B9238047843C3Cb0508b9EdeB3a7729D72c3"; // Contrato del Token OroBit
        const BNB_TESTNET_CHAIN_ID = '0x61'; // Chain ID para BNB Smart Chain Testnet
        const BNB_TESTNET_RPC_URL = 'https://data-seed-prebsc-1-s1.binance.org:8545/'; // RPC URL de la testnet
        const OWNER_WALLET_ADDRESS = "0x0C6DA70B1BB307D78d154ec6adbD57ff696E0660"; // Su cartera de propietario (REAL)
        const ADRIANA_WALLET_ADDRESS = "0x74ee74CA4e9deE9b15bC34aAc6615F324BAf2Bc5"; // Cartera de ADRIANA (para pruebas de usuario estándar)


        // URL para adquirir OroBit en PancakeSwap Testnet
        const PANCAKESWAP_TESTNET_URL = `https://pancakeswap.finance/swap?outputCurrency=${OROBIT_TOKEN_ADDRESS}&chainId=${parseInt(BNB_TESTNET_CHAIN_ID, 16)}`;


        // --- ABIs de los Contratos ---
        // ABI del Contrato de Staking (simplificado para funciones clave)
        const STAKING_CONTRACT_ABI = [
            // Funciones de Read Contract
            { "inputs": [], "name": "getContractTokenBalance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_poolId", "type": "uint256" }], "name": "getPool", "outputs": [{ "internalType": "uint256", "name": "duration", "type": "uint256" }, { "internalType": "uint256", "name": "aprBP", "type": "uint256" }, { "internalType": "bool", "name": "isActive", "type": "bool" }, { "internalType": "bool", "name": "isFlexible", "type": "bool" }], "stateMutability": "view", "type": "function" },
            { "inputs": [], "name": "getStakingPoolsLength", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, // Corrected: getStakingPoolsLength
            { "inputs": [{ "internalType": "address", "name": "_user", "type": "address" }, { "internalType": "uint256", "name": "_stakeId", "type": "uint256" }], "name": "getUserStake", "outputs": [{ "internalType": "uint256", "name": "amount", "type": "uint256" }, { "internalType": "uint256", "name": "startTime", "type": "uint256" }, { "internalType": "uint256", "name": "duration", "type": "uint256" }, { "internalType": "uint256", "name": "aprBP", "type": "uint256" }, { "internalType": "bool", "name": "withdrawn", "type": "bool" }, { "internalType": "uint256", "name": "lastRewardClaimed", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "address", "name": "_user", "type": "address" }], "name": "getUserStakesLength", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [], "name": "owner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
            { "inputs": [], "name": "earlyWithdrawPenaltyBP", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "address", "name": "_user", "type": "address" }, { "internalType": "uint256", "name": "_stakeId", "type": "uint256" }], "name": "calculateReward", "outputs": [{ "internalType": "uint256", "name": "reward", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            // Funciones de Write Contract
            { "inputs": [{ "internalType": "uint256", "name": "_poolId", "type": "uint256" }, { "internalType": "uint256", "name": "_amount", "type": "uint256" }], "name": "stake", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_stakeId", "type": "uint256" }], "name": "withdraw", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_duration", "type": "uint256" }, { "internalType": "uint256", "name": "_aprBP", "type": "uint256" }, { "internalType": "bool", "name": "_isFlexible", "type": "bool" }], "name": "addPool", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_poolId", "type": "uint256" }, { "internalType": "bool", "name": "_isActive", "type": "bool" }], "name": "setPoolStatus", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_amount", "type": "uint256" }], "name": "depositRewards", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "uint256", "name": "_newPenaltyBP", "type": "uint256" }], "name": "setEarlyWithdrawPenalty", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [], "name": "pause", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [], "name": "unpause", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
        ];

        // ABI del Contrato IERC20 (para el token OroBit)
        const OROBIT_TOKEN_ABI = [
            { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "balanceOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
            { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "approve", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" },
            { "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }], "name": "allowance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }
        ];

        // --- Global Variables ---
        let web3; // Web3 instance
        let stakingContract; // Staking contract instance
        let oroBitTokenContract; // OroBit token contract instance
        let currentAccount; // Connected MetaMask account
        let isOwner = false; // Flag to check if the connected account is the owner
        let currentUserOrobitBalance = '0'; // Store the user's OroBit balance


        // --- DOM Element References ---
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const walletStatus = document.getElementById('walletStatus');
        const accountAddressElem = document.getElementById('accountAddress');
        const statusMessage = document.getElementById('statusMessage');
        const errorMessage = document.getElementById('errorMessage');
        const txHashElem = document.getElementById('txHash');

        // Tabs
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Dashboard
        const userOrobitBalanceElem = document.getElementById('userOrobitBalance');
        const userTotalStakesElem = document.getElementById('userTotalStakes');
        const userStakesListElem = document.getElementById('userStakesList');
        const acquireOrobitBtn = document.getElementById('acquireOrobitBtn'); // New element
        const noPoolsMessage = document.getElementById('noPoolsMessage'); // New element
        const quickAddPoolBtn = document.getElementById('quickAddPoolBtn'); // New element
        const quickAddPoolDuration = document.getElementById('quickAddPoolDuration'); // New element
        const quickAddPoolAprBP = document.getElementById('quickAddPoolAprBP'); // New element
        const quickAddPoolIsFlexible = document.getElementById('quickAddPoolIsFlexible'); // New element

        // Stake
        const stakeAmountInput = document.getElementById('stakeAmountInput');
        const maxStakeAmountBtn = document.getElementById('maxStakeAmountBtn'); // New MAX button
        const poolSelect = document.getElementById('poolSelect');
        const approveStakeBtn = document.getElementById('approveStakeBtn');
        const stakeBtn = document.getElementById('stakeBtn');

        // Withdraw
        const withdrawStakeIdInput = document.getElementById('withdrawStakeIdInput');
        const executeWithdrawBtn = document.getElementById('executeWithdrawBtn');

        // Admin
        const adminTab = document.getElementById('admin-tab');
        const adminPoolDuration = document.getElementById('adminPoolDuration');
        const adminPoolAprBP = document.getElementById('adminPoolAprBP');
        const adminPoolIsFlexible = document.getElementById('adminPoolIsFlexible'); 
        const addPoolBtn = document.getElementById('addPoolBtn');
        const adminSetPoolId = document.getElementById('adminSetPoolId');
        const adminSetPoolActive = document.getElementById('adminSetPoolActive');
        const setPoolStatusBtn = document.getElementById('setPoolStatusBtn');
        const depositRewardsAmount = document.getElementById('depositRewardsAmount');
        const depositRewardsBtn = document.getElementById('depositRewardsBtn'); 
        const earlyWithdrawPenaltyBP = document.getElementById('earlyWithdrawPenaltyBP');
        const setEarlyWithdrawPenaltyBtn = document.getElementById('setEarlyWithdrawPenaltyBtn');

        // --- Utility Functions ---

        // Function to decode revert messages (contract errors)
        function decodeRevertReason(hexString) {
            if (!hexString || hexString.length < 10) return "Unknown revert reason";
            if (hexString.startsWith('0x08c379a0')) { // Error selector for Solidity's `Error(string)`
                try {
                    const dataPart = hexString.substring(10);
                    let decoded = '';
                    for (let i = 0; i < dataPart.length; i += 2) {
                        decoded += String.fromCharCode(parseInt(dataPart.substr(i, 2), 16));
                    }
                    decoded = decoded.replace(/[^ -~]+/g, ''); // Clean non-ASCII characters
                    if (decoded.length > 0) return `Revert: "${decoded.trim()}"`;
                } catch (e) {
                    console.warn("Error decoding revert reason:", e);
                }
            }
            return "Revert: No clear error message (hex: " + hexString.substring(0, Math.min(hexString.length, 100)) + "...)";
        }

        // Function to reset UI messages
        function resetMessages() {
            statusMessage.textContent = '';
            errorMessage.textContent = '';
            txHashElem.textContent = '';
        }

        // Function to convert from Wei to OroBit (and other cryptocurrencies with 18 decimals)
        function fromWei(amountInWei) {
            if (!web3) return 'N/A';
            return web3.utils.fromWei(amountInWei, 'ether');
        }

        // Function to convert from OroBit to Wei (for sending to the blockchain)
        function toWei(amountInOroBit) {
            if (!web3) return 'N/A';
            return web3.utils.toWei(amountInOroBit, 'ether');
        }

        // Function to update the visual state of the connect button
        function updateConnectButtonStatus(status) {
            const icon = connectWalletBtn.querySelector('i');
            switch (status) {
                case 'connecting':
                    connectWalletBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2 text-lg"></i> Connecting...';
                    connectWalletBtn.disabled = true;
                    connectWalletBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-green-600', 'hover:bg-green-700');
                    connectWalletBtn.classList.add('bg-purple-600', 'to-indigo-600', 'hover:from-purple-700', 'hover:to-indigo-700');
                    break;
                case 'connected':
                    connectWalletBtn.innerHTML = '<i class="fas fa-check-circle mr-2 text-lg"></i> MetaMask Connected';
                    connectWalletBtn.disabled = true; // Disable after connecting
                    connectWalletBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-purple-600', 'to-indigo-600', 'hover:from-purple-700', 'hover:to-indigo-700');
                    connectWalletBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    break;
                case 'disconnected':
                    connectWalletBtn.innerHTML = '<i class="fas fa-exclamation-triangle mr-2 text-lg"></i> Connect MetaMask';
                    connectWalletBtn.disabled = false;
                    connectWalletBtn.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-purple-600', 'to-indigo-600', 'hover:from-purple-700', 'hover:to-indigo-700');
                    connectWalletBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    break;
                case 'error':
                    connectWalletBtn.innerHTML = '<i class="fas fa-times-circle mr-2 text-lg"></i> Connection Error';
                    connectWalletBtn.disabled = false;
                    connectWalletBtn.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-purple-600', 'to-indigo-600', 'hover:from-purple-700', 'hover:to-indigo-700');
                    connectWalletBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    break;
                default:
                    connectWalletBtn.innerHTML = '<i class="fab fa-ethereum mr-2 text-lg"></i> Connect MetaMask';
                    connectWalletBtn.disabled = false;
                    connectWalletBtn.classList.remove('bg-green-600', 'bg-red-600', 'hover:bg-green-700', 'hover:bg-red-700');
                    connectWalletBtn.classList.add('bg-purple-600', 'to-indigo-600', 'hover:from-purple-700', 'hover:to-indigo-700');
                    break;
            }
        }


        // --- MetaMask Connection Logic ---
        async function connectWallet() {
            resetMessages();
            updateConnectButtonStatus('connecting'); // Update button to "Connecting..."
            console.log("DEBUG: connectWallet: Initializing MetaMask connection...");

            let attempts = 0;
            const maxAttempts = 5; // Try to detect MetaMask multiple times
            const retryDelay = 300; // Milliseconds between retries

            while (typeof window.ethereum === 'undefined' || !window.ethereum) {
                if (attempts >= maxAttempts) {
                    walletStatus.textContent = 'MetaMask not detected.';
                    errorMessage.textContent = 'Please install MetaMask to use this application. If you already have it, make sure it is enabled and that there are no other wallet extensions causing conflicts. Remember to enable "Allow in Incognito" for MetaMask if you are using this mode.';
                    console.error("DEBUG: MetaMask not detected after several attempts. window.ethereum is:", window.ethereum);
                    disableAllButtons();
                    updateConnectButtonStatus('error'); // Update button to "Disconnected/Error"
                    return;
                }
                console.log(`DEBUG: Attempt ${attempts + 1}/${maxAttempts}: MetaMask not detected. Retrying in ${retryDelay}ms...`);
                await new Promise(resolve => setTimeout(resolve, retryDelay));
                attempts++;
            }

            console.log("DEBUG: MetaMask (window.ethereum) detected.");

            // Step 2: Handle multiple providers (if applicable, prioritize MetaMask)
            if (window.ethereum.providers && window.ethereum.providers.length > 1) {
                const metamaskProvider = window.ethereum.providers.find((provider) => provider.isMetaMask);
                if (metamaskProvider) {
                    window.ethereum = metamaskProvider; // Set MetaMask as the primary provider
                    console.log("DEBUG: Multiple providers detected, prioritizing MetaMask.");
                } else {
                    errorMessage.textContent = 'Multiple wallets detected. Please disable other wallet extensions except MetaMask.';
                    walletStatus.textContent = 'Error: Conflicting wallets.';
                    console.error("DEBUG: Multiple conflicting wallets, MetaMask is not the primary provider.");
                    disableAllButtons();
                    updateConnectButtonStatus('error');
                    return;
                }
            }

            try {
                // Step 3: Initialize Web3 with the MetaMask provider
                web3 = new Web3(window.ethereum);
                console.log("DEBUG: Web3 initialized with window.ethereum.");

                // Step 4: Request access to accounts
                console.log("DEBUG: Requesting access to MetaMask accounts...");
                const accountsFromMetaMask = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                if (accountsFromMetaMask.length === 0) {
                    walletStatus.textContent = 'No account connected.';
                    accountAddressElem.textContent = '';
                    errorMessage.textContent = 'Please connect an account in MetaMask.';
                    console.warn("DEBUG: No accounts returned from MetaMask.");
                    disableAllButtons();
                    updateConnectButtonStatus('disconnected');
                    return;
                }

                currentAccount = window.ethereum.selectedAddress || accountsFromMetaMask[0];
                accountAddressElem.textContent = `Connected Account: ${currentAccount}`;
                
                // Step 5: Instantiate contracts
                stakingContract = new web3.eth.Contract(STAKING_CONTRACT_ABI, STAKING_CONTRACT_ADDRESS);
                oroBitTokenContract = new web3.eth.Contract(OROBIT_TOKEN_ABI, OROBIT_TOKEN_ADDRESS);
                console.log("DEBUG: Staking and token contracts instantiated.");

                // Step 6: Check and switch network if necessary
                const currentChainId = await web3.eth.getChainId();
                console.log("DEBUG: Current Chain ID:", currentChainId, "Expected:", parseInt(BNB_TESTNET_CHAIN_ID, 16));

                if (currentChainId !== parseInt(BNB_TESTNET_CHAIN_ID, 16)) {
                    console.log("DEBUG: Incorrect network. Attempting to switch to BNB Testnet.");
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: BNB_TESTNET_CHAIN_ID }],
                        });
                        walletStatus.textContent = 'MetaMask Connected! (Network switched to BNB Testnet)'; // Update here
                        console.log("DEBUG: Network switched successfully.");
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            console.log("DEBUG: Network not added. Attempting to add it.");
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: BNB_TESTNET_CHAIN_ID,
                                        chainName: 'BNB Smart Chain Testnet',
                                        rpcUrls: [BNB_TESTNET_RPC_URL],
                                        nativeCurrency: { name: 'BNB', symbol: 'tBNB', decimals: 18 },
                                        blockExplorerUrls: ['https://testnet.bscscan.com/'],
                                    }],
                                });
                                walletStatus.textContent = 'MetaMask Connected! (Network added and switched to BNB Testnet)'; // Update here
                                console.log("DEBUG: Network added and switched successfully.");
                            } catch (addError) {
                                console.error('Error adding network:', addError);
                                walletStatus.textContent = 'Warning! Could not add/switch to BNB Smart Chain Testnet.';
                                errorMessage.textContent = `Error: ${addError.message}`;
                                disableAllButtons();
                                updateConnectButtonStatus('error');
                                return;
                            }
                        } else {
                            console.error('Error switching network:', switchError);
                            walletStatus.textContent = 'Warning! Could not switch to BNB Smart Chain Testnet.';
                            errorMessage.textContent = `Error: ${switchError.message}`;
                            disableAllButtons();
                                updateConnectButtonStatus('error');
                            return;
                        }
                    }
                } else {
                    walletStatus.textContent = 'MetaMask Connected!'; // Default message if network is already correct
                }
                
                // Step 7: Check if it's the owner's account (after contracts are instantiated)
                const contractOwner = await stakingContract.methods.owner().call();
                isOwner = (currentAccount.toLowerCase() === OWNER_WALLET_ADDRESS.toLowerCase());
                console.log("DEBUG: Is owner:", isOwner);

                // Final dynamic connection message for walletStatus
                if (isOwner) {
                    walletStatus.textContent = `MetaMask Connected! (Connected as Owner)`;
                }
                // Clear errorMessage here if there's no real error
                errorMessage.textContent = '';
                
                if (isOwner) {
                    adminTab.style.display = 'block';
                } else {
                    adminTab.style.display = 'none';
                }

                // Step 8: Load data and enable buttons
                loadDashboardData();
                loadPoolsForStaking();
                enableButtonsIfConnected();
                updateConnectButtonStatus('connected'); // Update button to "Connected"
                console.log("DEBUG: Connection and initial data loading finished.");

            } catch (error) {
                console.error('General error connecting MetaMask:', error);
                walletStatus.textContent = 'Error connecting MetaMask.';
                errorMessage.textContent = `Error: ${error.message}`;
                disableAllButtons();
                updateConnectButtonStatus('error'); // Update button to "Error"
            }
        }

        // --- MetaMask Event Handling ---
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (newAccounts) => {
                console.log("DEBUG: accountsChanged event. New accounts:", newAccounts);
                if (newAccounts.length > 0) {
                    currentAccount = newAccounts[0];
                    accountAddressElem.textContent = `Connected Account: ${currentAccount}`;
                    // Reload all connection logic to ensure correct state
                    connectWallet(); 
                } else {
                    currentAccount = null;
                    accountAddressElem.textContent = 'No account connected.';
                    walletStatus.textContent = 'Please connect MetaMask.';
                    disableAllButtons();
                    adminTab.style.display = 'none';
                    resetDashboardData();
                    updateConnectButtonStatus('disconnected');
                    console.log("DEBUG: Accounts changed: no account connected.");
                }
            });

            window.ethereum.on('chainChanged', async (chainId) => {
                console.log("DEBUG: chainChanged event. New Chain ID:", chainId);
                // Reload all connection logic to ensure correct state
                connectWallet();
            });
        }


        // --- Button Enable/Disable Logic ---
        function disableAllButtons() {
            approveStakeBtn.disabled = true;
            stakeBtn.disabled = true;
            executeWithdrawBtn.disabled = true;
            addPoolBtn.disabled = true;
            setPoolStatusBtn.disabled = true;
            depositRewardsBtn.disabled = true;
            setEarlyWithdrawPenaltyBtn.disabled = true;
            quickAddPoolBtn.disabled = true; // Disable quick button
            maxStakeAmountBtn.disabled = true; // Disable MAX button
            console.log("DEBUG: All buttons disabled.");
        }

        function enableButtonsIfConnected() {
            if (currentAccount && stakingContract && oroBitTokenContract) {
                approveStakeBtn.disabled = false;
                executeWithdrawBtn.disabled = false;
                maxStakeAmountBtn.disabled = false; // Enable MAX button
                console.log("DEBUG: User buttons (stake, withdraw) ENABLED.");
                console.log("DEBUG: Current state of executeWithdrawBtn.disabled:", executeWithdrawBtn.disabled);


                if (isOwner) {
                    addPoolBtn.disabled = false;
                    setPoolStatusBtn.disabled = false;
                    depositRewardsBtn.disabled = false;
                    setEarlyWithdrawPenaltyBtn.disabled = false;
                    quickAddPoolBtn.disabled = false; // Enable quick button for owner
                    console.log("DEBUG: Admin buttons ENABLED.");
                } else {
                    addPoolBtn.disabled = true;
                    setPoolStatusBtn.disabled = true;
                    depositRewardsBtn.disabled = true;
                    setEarlyWithdrawPenaltyBtn.disabled = true;
                    quickAddPoolBtn.disabled = true; // Disable quick button if not owner
                    console.log("DEBUG: Admin buttons disabled (not owner).");
                }
            } else {
                disableAllButtons();
                console.log("DEBUG: Accounts/Contracts not ready, buttons disabled.");
            }
        }

        // --- Dashboard Data Loading Functions ---
        async function loadDashboardData() {
            if (!currentAccount || !stakingContract || !oroBitTokenContract) {
                resetDashboardData();
                return;
            }
            console.log("DEBUG: loadDashboardData: Loading dashboard data for", currentAccount);
            // Load user's OroBit balance
            try {
                const balanceWei = await oroBitTokenContract.methods.balanceOf(currentAccount).call();
                currentUserOrobitBalance = fromWei(balanceWei); // Store balance
                userOrobitBalanceElem.textContent = `${currentUserOrobitBalance} OROBIT`;
                console.log("DEBUG: User's OroBit balance loaded:", currentUserOrobitBalance);
            } catch (error) {
                console.error("Error loading OroBit balance:", error);
                userOrobitBalanceElem.textContent = "Error loading balance.";
                errorMessage.textContent = `Error loading OroBit balance: ${error.message}`;
            }

            // Load user's stakes
            try {
                const userStakesLength = await stakingContract.methods.getUserStakesLength(currentAccount).call();
                userTotalStakesElem.textContent = `${userStakesLength} stakes`;
                userStakesListElem.innerHTML = ''; // Clear previous list
                console.log("DEBUG: Total user stakes:", userStakesLength);

                if (userStakesLength > 0) {
                    for (let i = 0; i < userStakesLength; i++) {
                        try { // Added try-catch for individual stake loading
                            const stake = await stakingContract.methods.getUserStake(currentAccount, i).call();
                            let reward = "0"; // Default to 0 for display
                            // Only calculate reward if stake has not been withdrawn
                            if (!stake.withdrawn) {
                                reward = await stakingContract.methods.calculateReward(currentAccount, i).call();
                            }
                            
                            const stakeItem = document.createElement('div');
                            stakeItem.className = 'bg-gray-800 bg-opacity-40 p-3 rounded-md text-gray-200';
                            
                            let statusText = stake.withdrawn ? '<span class="text-red-400">Withdrawn</span>' : '<span class="text-green-400">Active</span>';
                            
                            const startTime = new Date(parseInt(stake.startTime) * 1000).toLocaleString();
                            const endTime = stake.duration > 0 ? new Date((parseInt(stake.startTime) + parseInt(stake.duration)) * 1000).toLocaleString() : 'N/A';
                            
                            stakeItem.innerHTML = `
                                <p class="font-semibold">ID: ${i} (${statusText})</p>
                                <p>Amount: ${fromWei(stake.amount)} OROBIT</p>
                                <p>APR: ${stake.aprBP / 100}%</p>
                                <p>Start: ${startTime}</p>
                                ${stake.isFlexible ? `<p>Type: Flexible</p>` : `<p>Duration: ${stake.duration / (24 * 60 * 60)} days</p><p>End: ${endTime}</p>`}
                                <p>Accumulated Reward: ${fromWei(reward)} OROBIT</p>
                            `;
                            userStakesListElem.appendChild(stakeItem);
                            console.log(`DEBUG: Stake ${i} loaded:`, stake);
                        } catch (stakeError) {
                            console.error(`Error loading stake ID ${i} for user ${currentAccount}:`, stakeError);
                            const errorItem = document.createElement('div');
                            errorItem.className = 'bg-red-900 bg-opacity-40 p-3 rounded-md text-red-300';
                            errorItem.textContent = `Error loading stake ID ${i}: ${decodeRevertReason(stakeError.data) || stakeError.message.substring(0, Math.min(stakeError.message.length, 100))}...`;
                            userStakesListElem.appendChild(errorItem);
                        }
                    }
                } else {
                    userStakesListElem.innerHTML = '<p class="text-center text-gray-400">You have no active stakes.</p>';
                }

            } catch (error) {
                console.error("Error loading user's stakes:", error);
                userTotalStakesElem.textContent = "Error loading stakes.";
                errorMessage.textContent = `Error loading your stakes: ${error.message}`;
                userStakesListElem.innerHTML = '<p class="text-red-400 text-center">Error loading your stakes. Check console.</p>';
            }
        }

        function resetDashboardData() {
            userOrobitBalanceElem.textContent = 'N/A';
            userTotalStakesElem.textContent = 'N/A';
            userStakesListElem.innerHTML = '';
            console.log("DEBUG: Dashboard data reset.");
        }

        // --- Staking Logic ---
        // New handler for the MAX button
        maxStakeAmountBtn.addEventListener('click', () => {
            if (currentUserOrobitBalance !== '0') {
                stakeAmountInput.value = currentUserOrobitBalance;
            } else {
                stakeAmountInput.value = 0;
            }
        });

        async function loadPoolsForStaking() {
            if (!stakingContract) {
                poolSelect.innerHTML = '<option value="" disabled>Error loading pools.</option>';
                console.error("DEBUG: loadPoolsForStaking: stakingContract not defined.");
                // Show no pools message if contract is not ready
                if (isOwner) {
                    noPoolsMessage.classList.remove('hidden');
                } else {
                    noPoolsMessage.classList.add('hidden');
                }
                return;
            }
            console.log("DEBUG: loadPoolsForStaking: Loading pools...");
            
            let poolLength = 0;
            let poolsFound = false; // Flag to know if active pools were found
            try {
                // KEY CORRECTION: Use the correct function name: getStakingPoolsLength()
                poolLength = await stakingContract.methods.getStakingPoolsLength().call(); 
                console.log("DEBUG: Number of pools detected:", poolLength);
            } catch (error) {
                console.error("Error getting pool length:", error);
                poolSelect.innerHTML = '<option value="" disabled selected>Error loading pools: Could not get length.</option>';
                errorMessage.textContent = `Error loading staking pools: Could not get pool length. ${error.message}`;
                // Show no pools message if length cannot be obtained and is owner
                if (isOwner) {
                    noPoolsMessage.classList.remove('hidden');
                } else {
                    noPoolsMessage.classList.add('hidden');
                }
                return; // Exit if length cannot be obtained
            }

            poolSelect.innerHTML = '<option value="" disabled selected>Select a pool...</option>'; // Reset

            const uniquePools = {}; // Use an object to store unique pools by their characteristics
            if (poolLength > 0) {
                for (let i = 0; i < poolLength; i++) {
                    try { // Added try-catch for individual pool loading
                        const pool = await stakingContract.methods.getPool(i).call();
                        if (pool.isActive) {
                            const durationText = pool.isFlexible ? 'Flexible' : `${pool.duration / (24 * 60 * 60)} days`;
                            const poolKey = `${durationText}-${pool.aprBP / 100}%`; // Unique key for the pool
                            
                            if (!uniquePools[poolKey]) {
                                uniquePools[poolKey] = {
                                    duration: pool.duration,
                                    aprBP: pool.aprBP,
                                    isFlexible: pool.isFlexible,
                                    ids: [i] // Save the first ID found
                                };
                            } else {
                                uniquePools[poolKey].ids.push(i); // Add additional IDs if the pool is identical
                            }
                            poolsFound = true; // At least one active pool was found
                            console.log(`DEBUG: Pool ${i} loaded:`, pool);
                        }
                    } catch (poolError) {
                        console.error(`Error loading pool ID ${i}:`, poolError);
                        // We don't add error options to the select, we just log.
                    }
                }
            }
            
            // Add unique options to the select
            if (poolsFound) {
                for (const key in uniquePools) {
                    const poolData = uniquePools[key];
                    const option = document.createElement('option');
                    // Show all IDs for transparency, or choose only the first
                    option.value = poolData.ids[0]; // Use the first ID for the value
                    let idText = poolData.ids.length > 1 ? `IDs: ${poolData.ids.join(', ')}` : `ID: ${poolData.ids[0]}`;
                    option.textContent = `${idText} | Type: ${key.split('-')[0]} | APR: ${key.split('-')[1]}`;
                    poolSelect.appendChild(option);
                }
                noPoolsMessage.classList.add('hidden'); // Hide if there are pools
            } else { // If no active pools were found
                poolSelect.innerHTML = '<option value="" disabled selected>No active or available pools.</option>';
                console.log("DEBUG: No active pools to display.");
                if (isOwner) { // Show no pools message if owner
                    noPoolsMessage.classList.remove('hidden');
                } else {
                    noPoolsMessage.classList.add('hidden');
                }
            }
        }

        approveStakeBtn.addEventListener('click', async () => {
            resetMessages();
            if (!currentAccount) {
                errorMessage.textContent = 'Please connect your MetaMask first.';
                return;
            }
            const amount = stakeAmountInput.value;
            if (isNaN(amount) || parseFloat(amount) <= 0) {
                errorMessage.textContent = 'Please enter a valid amount to stake.';
                return;
            }

            statusMessage.textContent = 'Approving tokens for staking...';
            try {
                const amountWei = toWei(amount);
                const tx = await oroBitTokenContract.methods.approve(STAKING_CONTRACT_ADDRESS, amountWei).send({ from: currentAccount });
                statusMessage.textContent = `Approval Successful! Hash: ${tx.transactionHash}`;
                txHashElem.textContent = `Transaction Hash: ${tx.transactionHash}`;
                stakeBtn.disabled = false; // Enable stake button
            } catch (error) {
                console.error('Error approving tokens:', error);
                statusMessage.textContent = 'Error approving tokens.';
                errorMessage.textContent = `Error: ${error.message}. Check MetaMask.`;
            }
        });

        stakeBtn.addEventListener('click', async () => {
            resetMessages();
            if (!currentAccount) {
                errorMessage.textContent = 'Please connect your MetaMask first.';
                return;
            }
            const poolId = poolSelect.value;
            const amount = stakeAmountInput.value;

            if (!poolId) {
                errorMessage.textContent = 'Please select a staking pool.';
                return;
            }
            if (isNaN(amount) || parseFloat(amount) <= 0) {
                errorMessage.textContent = 'Please enter a valid amount to stake.';
                return;
            }

            statusMessage.textContent = 'Sending stake transaction...';
            try {
                const amountWei = toWei(amount);
                const tx = await stakingContract.methods.stake(parseInt(poolId), amountWei).send({ from: currentAccount });
                statusMessage.textContent = `Stake Successful! Hash: ${tx.transactionHash}`;
                txHashElem.textContent = `Transaction Hash: ${tx.transactionHash}`;
                // Update dashboard after successful stake
                await loadDashboardData();
            }
            catch (error) {
                console.error('Error staking tokens:', error);
                statusMessage.textContent = 'Error staking tokens.';
                errorMessage.textContent = `Error: ${error.message}. Check MetaMask.`;
            }
        });

        // --- Withdraw Logic ---
        executeWithdrawBtn.addEventListener('click', async () => {
            console.log("DEBUG: 'Withdraw Stake' button (executeWithdrawBtn) clicked."); // Debugging: log at the beginning of the handler
            resetMessages();
            if (!currentAccount) {
                errorMessage.textContent = 'Please connect your MetaMask first.';
                console.error("DEBUG: Withdraw: currentAccount is not defined."); // Debugging: Error if account is not defined
                return;
            }

            console.log("DEBUG: Current account:", currentAccount); // Debugging: Show current account
            console.log("DEBUG: Staking contract:", stakingContract); // Debugging: Show staking contract object
            console.log("DEBUG: OroBit Token Contract:", oroBitTokenContract); // Debugging: Show token contract object

            const stakeId = parseInt(withdrawStakeIdInput.value);
            if (isNaN(stakeId)) {
                errorMessage.textContent = 'Please enter a valid stake ID.';
                console.error("DEBUG: Withdraw: Invalid stake ID:", withdrawStakeIdInput.value); // Debugging: Error if ID is invalid
                return;
            }

            statusMessage.textContent = 'Preparing withdrawal transaction...';
            try {
                console.log("DEBUG: Attempting to send withdrawal transaction for stakeId:", stakeId); // Debugging: Log before sending transaction
                const tx = await stakingContract.methods.withdraw(stakeId).send({ from: currentAccount });
                statusMessage.textContent = `Withdrawal Transaction Successful!`;
                txHashElem.textContent = `Transaction Hash: ${tx.transactionHash}`;
                console.log("DEBUG: Withdrawal transaction successful. Hash:", tx.transactionHash); // Debugging: Log if transaction is successful
                // Update dashboard after successful withdrawal
                await loadDashboardData();
            } catch (error) {
                console.error('DEBUG: Error sending withdrawal transaction:', error); // Debugging: Log the error
                statusMessage.textContent = 'Error sending withdrawal transaction.';
                errorMessage.textContent = `Error: ${error.message}. Please check MetaMask.`;
                // Try to get more detailed revert reason
                if (error.code === -32000 || error.code === 3) {
                    try {
                        const transactionParameters = {
                            to: STAKING_CONTRACT_ADDRESS,
                            from: currentAccount,
                            data: web3.eth.abi.encodeFunctionCall({
                                name: "withdraw",
                                type: "function",
                                inputs: [{ internalType: "uint256", name: "_stakeId", type: "uint256" }]
                            }, [stakeId])
                        };
                        console.log("DEBUG: Attempting eth_call for revert reason with params:", transactionParameters); // Debugging: Log before eth_call
                        const callResult = await web3.eth.call(transactionParameters);
                        if (callResult && callResult !== '0x') {
                            errorMessage.textContent += ` ${decodeRevertReason(callResult)}`;
                        } else {
                            errorMessage.textContent += ' (Could not get exact revert reason.)';
                        }
                    } catch (callError) {
                        console.warn("DEBUG: Could not get revert reason with eth_call:", callError); // Debugging: Log if eth_call fails
                        errorMessage.textContent += ' (Could not get exact revert reason.)';
                    }
                }
            }
        });

        // --- Admin Logic (Owner Only) ---
        addPoolBtn.addEventListener('click', async () => {
            resetMessages();
            if (!currentAccount || !isOwner) {
                errorMessage.textContent = 'Access denied: only the owner can add pools.';
                return;
            }
            const duration = parseInt(adminPoolDuration.value);
            const aprBP = parseInt(adminPoolAprBP.value);
            const isFlexible = adminPoolIsFlexible.checked;

            if (isNaN(duration) || isNaN(aprBP) || aprBP < 0 || aprBP > 100000) {
                errorMessage.textContent = 'Please enter valid values for the pool (APR between 0 and 100000).';
                return;
            }

            statusMessage.textContent = 'Adding new pool...';
            try {
                const tx = await stakingContract.methods.addPool(duration, aprBP, isFlexible).send({ from: currentAccount });
                statusMessage.textContent = `Pool added successfully! Hash: ${tx.transactionHash}`;
                txHashElem.textContent = `Transaction Hash: ${tx.transactionHash}`;
                await loadPoolsForStaking(); // Reload pool list
            } catch (error) {
                console.error('Error adding pool:', error);
                statusMessage.textContent = 'Error adding pool.';
                errorMessage.textContent = `Error: ${error.message}. Check MetaMask.`;
            }
        });

        // New handler for the "Quick Add Pool" button on the dashboard
        quickAddPoolBtn.addEventListener('click', async () => {
            resetMessages();
            if (!currentAccount || !isOwner) {
                errorMessage.textContent = 'Access denied: only the owner can add pools.';
                return;
            }
            const duration = parseInt(quickAddPoolDuration.value);
            const aprBP = parseInt(quickAddPoolAprBP.value);
            const isFlexible = quickAddPoolIsFlexible.checked;

            if (isNaN(duration) || isNaN(aprBP) || aprBP < 0 || aprBP > 100000) {
                errorMessage.textContent = 'Please enter valid values for the pool (APR between 0 and 100000).';
                return;
            }

            statusMessage.textContent = 'Adding new quick pool...';
            try {
                const tx = await stakingContract.methods.addPool(duration, aprBP, isFlexible).send({ from: currentAccount });
                statusMessage.textContent = `Pool added successfully! Hash: ${tx.transactionHash}`;
                txHashElem.textContent = `Transaction Hash: ${tx.transactionHash}`;
                await loadPoolsForStaking(); // Reload pool list
                // Hide no pools message after adding one
                noPoolsMessage.classList.add('hidden');
            } catch (error) {
                console.error('Error adding quick pool:', error);
                statusMessage.textContent = 'Error adding quick pool.';
                errorMessage.textContent = `Error: ${error.message}. Check MetaMask.`;
            }
        });


        setPoolStatusBtn.addEventListener('click', async () => {
            resetMessages();
            if (!currentAccount || !isOwner) {
                errorMessage.textContent = 'Access denied: only the owner can change pool status.';
                return;
            }
            const poolId = parseInt(adminSetPoolId.value);
            const isActive = adminSetPoolActive.checked;

            if (isNaN(poolId) || poolId < 0) {
                errorMessage.textContent = 'Please enter a valid pool ID.';
                return;
            }

            statusMessage.textContent = 'Updating pool status...';
            try {
                const tx = await stakingContract.methods.setPoolStatus(poolId, isActive).send({ from: currentAccount });
                statusMessage.textContent = `Pool status updated! Hash: ${tx.transactionHash}`;
                txHashElem.textContent = `Transaction Hash: ${tx.transactionHash`;
                await loadPoolsForStaking(); // Reload pool list
                await loadDashboardData(); // Refresh dashboard in case it affects active stakes
            } catch (error) {
                console.error('Error updating pool status:', error);
                statusMessage.textContent = 'Error updating pool status.';
                errorMessage.textContent = `Error: ${error.message}. Check MetaMask.`;
            }
        });

        depositRewardsBtn.addEventListener('click', async () => {
            resetMessages();
            if (!currentAccount || !isOwner) {
                errorMessage.textContent = 'Access denied: only the owner can deposit rewards.';
                return;
            }
            const amount = depositRewardsAmount.value;
            if (isNaN(amount) || parseFloat(amount) <= 0) {
                errorMessage.textContent = 'Please enter a valid amount to deposit.';
                return;
            }

            statusMessage.textContent = 'Approving tokens for reward deposit...';
            try {
                const amountWei = toWei(amount);
                // First, approve the staking contract to take tokens from the owner
                await oroBitTokenContract.methods.approve(STAKING_CONTRACT_ADDRESS, amountWei).send({ from: currentAccount });
                
                statusMessage.textContent = 'Depositing rewards...';
                // Then, call depositRewards on the staking contract
                const tx = await stakingContract.methods.depositRewards(amountWei).send({ from: currentAccount });
                statusMessage.textContent = `Rewards deposited successfully! Hash: ${tx.transactionHash}`;
                txHashElem.textContent = `Transaction Hash: ${tx.transactionHash}`; 
                await loadDashboardData(); // Update staking contract balance on dashboard
            } catch (error) {
                console.error('Error depositing rewards:', error);
                statusMessage.textContent = 'Error depositing rewards.';
                errorMessage.textContent = `Error: ${error.message}. Check MetaMask.`;
            }
        });

        setEarlyWithdrawPenaltyBtn.addEventListener('click', async () => {
            resetMessages();
            if (!currentAccount || !isOwner) {
                errorMessage.textContent = 'Access denied: only the owner can set the penalty.';
                return;
            }
            const penaltyBP = parseInt(earlyWithdrawPenaltyBP.value);
            if (isNaN(penaltyBP) || penaltyBP < 0 || penaltyBP > 10000) {
                errorMessage.textContent = 'Please enter a valid penalty (0-10000 Basis Points).';
                return;
            }

            statusMessage.textContent = 'Setting early withdrawal penalty...';
            try {
                const tx = await stakingContract.methods.setEarlyWithdrawPenalty(penaltyBP).send({ from: currentAccount });
                statusMessage.textContent = `Penalty set! Hash: ${tx.transactionHash}`;
                txHashElem.textContent = `Transaction Hash: ${tx.transactionHash}`; 
            } catch (error) {
                console.error('Error setting penalty:', error);
                statusMessage.textContent = 'Error setting penalty.';
                errorMessage.textContent = `Error: ${error.message}. Check MetaMask.`;
            }
        });


        // --- Tab Logic ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Remove 'active' from all buttons and content
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                // Add 'active' to the current button and content
                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');

                // Reload data if it's the dashboard
                if (button.dataset.tab === 'dashboard-tab') {
                    loadDashboardData();
                } else if (button.dataset.tab === 'stake-tab') {
                    loadPoolsForStaking(); // Ensure pools are loaded when going to stake tab
                }
            });
        });

        // --- Initialization ---
        window.addEventListener('load', () => {
            // Connect MetaMask on page load
            connectWallet(); // Call connection function on load
            
            // Configure link to acquire OroBit
            acquireOrobitBtn.href = PANCAKESWAP_TESTNET_URL;
        });

    </script>
</body>
</html>
