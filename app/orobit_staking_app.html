<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OroBitverse DApp - Staking & Retiro</title>
    <!-- Favicon para OroBitverse -->
    <!-- Ruta corregida para tu estructura de carpetas local: `../images/favicons/favicon.ico` -->
    <link rel="icon" href="../images/favicons/favicon.ico" type="image/x-icon">

    <!-- Content Security Policy (CSP): CORREGIDA Y OPTIMIZADA -->
    <!-- Se eliminaron los comentarios dentro de la directiva 'content' para evitar errores de sintaxis. -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' data: gap: https://ssl.gstatic.com;
        style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com;
        script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.jsdelivr.net https://unpkg.com;
        connect-src 'self' https://*.binance.org https://rpc.ankr.com;
        img-src 'self' data: content: https://www.orobitverse.com;
        media-src *;
        font-src 'self' data: https://fonts.gstatic.com;
        frame-src 'self' https://www.facebook.com;
    ">

    <style>
        /* Estilos base con Inter font y colores oscuros */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Fondo oscuro principal */
            color: #e0e0e0; /* Texto claro */
        }
        .card {
            background-color: #16213e; /* Fondo ligeramente más claro para tarjetas */
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #0f3460;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #1a4d7d;
        }
        .input-field {
            background-color: #0f3460;
            border: 1px solid #1a1a2e;
            color: #e0e0e0;
            padding: 10px 15px;
            border-radius: 8px;
        }
        /* Estilos para el cuadro de mensajes (no es un alert() nativo) */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #28a745; /* Verde para éxito */
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none; /* Oculto por defecto */
            text-align: center;
        }
        .message-box.error {
            background-color: #dc3545; /* Rojo para error */
        }
        .message-box.warning {
            background-color: #ffc107; /* Naranja para advertencia */
        }
        .message-box.info {
            background-color: #17a2b8; /* Azul para información */
        }
        .tab-button.active {
            background-color: #0f3460; /* Color para pestaña activa */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Elemento para mostrar mensajes al usuario (no es un alert nativo) -->
    <div id="messageBox" class="message-box"></div>

    <header class="bg-gray-800 text-white p-4 shadow-md flex justify-between items-center">
        <div class="flex items-center">
            <!-- RUTA DEL LOGO: Corregida para tu estructura de carpetas local: `../images/logo/main-logo.svg` -->
            <img src="../images/logo/main-logo.svg" alt="OroBitverse Logo" class="h-10 mr-3">
            <h1 class="text-2xl font-bold">OroBitverse</h1>
        </div>
        <div class="flex items-center space-x-4">
            <div id="walletStatus" class="flex items-center hidden"> <!-- Oculto por defecto hasta conectar -->
                <span id="walletAddress" class="text-sm">Conectado: 0x000...0000</span>
                <button id="disconnectWalletBtn" class="ml-2 px-3 py-1 bg-red-600 hover:bg-red-700 rounded-md text-sm">Desconectar Cartera</button>
            </div>
            <button id="connectWalletBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-md text-sm">Conectar Cartera</button>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-6">
        <div class="flex flex-col md:flex-row justify-center items-start md:space-x-8 space-y-6 md:space-y-0">
            <!-- Pestañas de Navegación -->
            <div class="w-full md:w-1/4 bg-gray-700 card p-4">
                <nav class="flex flex-col space-y-2">
                    <button id="miDashboardTab" class="tab-button bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-md text-left active">Mi Dashboard</button>
                    <button id="stakeTab" class="tab-button bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-md text-left">Stakear</button>
                    <button id="withdrawTab" class="tab-button bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-md text-left">Retirar</button>
                    <button id="adminTab" class="tab-button bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-md text-left">Admin</button>
                </nav>
            </div>

            <!-- Áreas de Contenido -->
            <div class="w-full md:w-3/4 bg-gray-700 card p-6">
                <!-- Contenido de Mi Dashboard -->
                <div id="miDashboardContent" class="tab-content">
                    <h2 class="text-xl font-semibold mb-4">Mi Dashboard</h2>
                    <p>Aquí verás un resumen de tus tokens stakeados y recompensas.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div class="bg-gray-600 p-4 rounded-md">
                            <h3 class="font-semibold">Tokens Stakeados</h3>
                            <p id="stakedBalance" class="text-2xl mt-2">0 OROBIT</p>
                        </div>
                        <div class="bg-gray-600 p-4 rounded-md">
                            <h3 class="font-semibold">Recompensas Pendientes</h3>
                            <p id="pendingRewards" class="text-2xl mt-2">0 OROBIT</p>
                        </div>
                    </div>
                     <h3 class="text-xl font-semibold mt-6 mb-4">Mis Stakes Activos</h3>
                    <div id="activeStakes" class="space-y-4">
                        <p class="text-gray-400">Cargando tus stakes...</p>
                    </div>
                </div>

                <!-- Contenido de Staking -->
                <div id="stakeContent" class="tab-content hidden">
                    <h2 class="text-xl font-semibold mb-4">Stakear OroBit</h2>
                    <div class="mb-4">
                        <label for="stakeAmount" class="block text-sm font-medium text-gray-300 mb-2">Cantidad a Stakear (OROBIT)</label>
                        <div class="flex">
                            <input type="number" id="stakeAmount" class="input-field flex-grow mr-2" placeholder="Ej: 100" min="1">
                            <button id="maxStakeBtn" class="btn-primary px-4 py-2">MAX</button>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label for="stakingPoolSelect" class="block text-sm font-medium text-gray-300 mb-2">Seleccionar Pool de Staking:</label>
                        <select id="stakingPoolSelect" class="input-field w-full">
                            <option value="">Cargando pools...</option>
                        </select>
                    </div>
                    <button id="approveStakeBtn" class="btn-primary w-full mb-3">Aprobar OroBit</button>
                    <button id="confirmStakeBtn" class="btn-primary w-full">Confirmar Stake</button>

                    <div id="stakingApprovalMessage" class="hidden mt-4 p-4 bg-blue-800 text-white rounded-md">
                        <p>Aprobando <span id="approvalAmount">0</span> OROBIT para el contrato de staking. Por favor, **revisa y confirma la transacción en tu extensión de MetaMask.**</p>
                    </div>
                </div>

                <!-- Contenido de Retiro -->
                <div id="withdrawContent" class="tab-content hidden">
                    <h2 class="text-xl font-semibold mb-4">Retirar OroBit</h2>
                    <div class="mb-4">
                        <label for="withdrawStakeId" class="block text-sm font-medium text-gray-300 mb-2">ID de tu Stake a Retirar:</label>
                        <input type="number" id="withdrawStakeId" class="input-field flex-grow mr-2" placeholder="Ej: 0" min="0">
                    </div>
                    <button id="calculateRewardBtn" class="btn-primary w-full mb-3">Calcular Recompensa</button>
                    <p id="calculatedRewardDisplay" class="text-center text-lg text-green-300 mb-6 hidden">
                        Recompensa estimada: <span class="font-bold">0.00 OROBIT</span>
                    </p>
                    <button id="confirmWithdrawBtn" class="btn-primary w-full">Confirmar Retiro</button>

                    <div id="withdrawalMessage" class="hidden mt-4 p-4 bg-yellow-800 text-white rounded-md">
                        <p>Iniciando el retiro del Stake ID <span id="withdrawalId">0</span>. Por favor, **revisa y confirma la transacción en tu extensión de MetaMask.**</p>
                    </div>
                </div>

                <!-- Contenido de Admin -->
                <div id="adminContent" class="tab-content hidden">
                    <h2 class="text-xl font-semibold mb-4">Panel de Administración</h2>
                    <p id="adminMessage" class="text-red-400">Acceso restringido. Solo el propietario del contrato puede ver este panel.</p>
                    <div id="adminPanel" class="space-y-4 mt-4 hidden">
                        <!-- Añadir Nuevo Pool de Staking -->
                        <div class="card p-4">
                            <h3 class="font-semibold mb-2">Añadir Nuevo Pool</h3>
                            <input type="number" id="adminPoolDuration" class="input-field w-full mb-2" placeholder="Duración (segundos, 0 para flexible)">
                            <input type="number" id="adminPoolAPR" class="input-field w-full mb-2" placeholder="APR (puntos base, ej. 500 para 5%)">
                            <label class="flex items-center mb-2">
                                <input type="checkbox" id="adminIsFlexiblePool" class="form-checkbox">
                                <span class="ml-2 text-gray-300">Es Flexible</span>
                            </label>
                            <button id="addPoolBtn" class="btn-primary w-full">Añadir Pool</button>
                        </div>
                        <!-- Otras funciones de admin si es necesario -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-gray-400 p-4 text-center mt-auto">
        <p>&copy; 2025 OroBitverse. Todos los derechos reservados.</p>
        <div class="flex justify-center space-x-4 mt-2">
            <a href="https://www.facebook.com/orobitverse" target="_blank" class="hover:text-white">Facebook</a>
            <a href="https://t.me/orobitverse" target="_blank" class="hover:text-white">Telegram</a>
            <a href="https://twitter.com/orobitverse" target="_blank" class="hover:text-white">X (Twitter)</a>
            <a href="https://youtube.com/@orobitverse" target="_blank" class="hover:text-white">YouTube</a>
            <a href="https://reddit.com/r/orobitverse" target="_blank" class="hover:text-white">Reddit</a>
        </div>
    </footer>

    <!-- Usando un CDN fiable para ethers.js -->
    <script src="https://unpkg.com/ethers@5.7.0/dist/ethers.umd.min.js" type="application/javascript"></script>
    <script>
        // VERIFICACIÓN CRÍTICA: ¿Se cargó ethers.js?
        // Este log y mensaje nos dirán inmediatamente si la librería esencial está faltando.
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof ethers === 'undefined') {
                console.error("ERROR CRÍTICO: La librería Ethers.js NO se ha cargado. Esto impedirá toda interacción con la blockchain. Posibles causas: problemas de red, CSP bloqueando 'unpkg.com', o el archivo no se encontró. Asegúrate de haber reiniciado completamente el navegador después de cualquier cambio.");
                const msgBox = document.getElementById('messageBox');
                msgBox.textContent = "ERROR CRÍTICO: Ethers.js no cargado. Revisa la consola del navegador.";
                msgBox.className = 'message-box error';
                msgBox.style.display = 'block';
            } else {
                console.log("Ethers.js cargado exitosamente. Tipo de 'ethers':", typeof ethers);
                // Si ethers está cargado, podemos inicializar el resto de la DApp
                initializeDApp();
            }
        });

        // La función initializeDApp contendrá el resto de tu lógica para asegurar que solo se ejecuta si ethers está disponible.
        function initializeDApp() {
            // --- Configuración de Contratos Inteligentes ---
            const OROBIT_TOKEN_ADDRESS = "0x8bC4B9238047843C3Cb0508b9EdeB3a7729D72c3"; // Dirección de tu token OroBit (Testnet)
            const STAKING_CONTRACT_ADDRESS = "0x8278eBAdBC25BEea94d6370174b8Eeb7b5bfD253"; // Dirección de tu contrato de Staking (Testnet)
            const OWNER_ADDRESS = "0x0C6DA70B1BB307D78d154ec6adbD57ff696E0660"; // Dirección del propietario del contrato

            const BASIS_POINTS_DIVISOR = 10000; // Para convertir puntos base a porcentajes

            // ABI COMPLETO DEL TOKEN OROBIT (COPIADO DIRECTAMENTE DE BSCScan)
            const OROBIT_TOKEN_ABI = [{"inputs":[{"internalType":"address","name":"initialOwner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":false,"internalType":"bool","name":"excluded","type":"bool"}],"name":"ExcludedFromFees","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"marketingFee","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"burnFee","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"reflectionFee","type":"uint256"}],"name":"FeesUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousWallet","type":"address"},{"indexed":true,"internalType":"address","name":"newWallet","type":"address"}],"name":"MarketingWalletUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Reflected","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"inputs":[],"name":"INITIAL_SUPPLY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_BPS","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"burnFeeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"bool","name":"excluded","type":"bool"}],"name":"excludeFromFees","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"isExcludedFromFees","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"marketingFeeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"marketingWallet","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"reflectionFeeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_marketingFeeBP","type":"uint256"},{"internalType":"uint256","name":"_burnFeeBP","type":"uint256"},{"internalType":"uint256","name":"_reflectionFeeBP","type":"uint256"}],"name":"setFees","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalFeeBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newWallet","type":"address"}],"name":"updateMarketingWallet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"tokenAddress","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"withdrawStuckTokens","outputs":[],"stateMutability":"nonpayable","type":"function"}];


            // ABI COMPLETO DEL CONTRATO DE STAKING (COPIADO DIRECTAMENTE DE BSCScan, Mantenido del turno anterior)
            const STAKING_CONTRACT_ABI = [{"inputs":[{"internalType":"contract IERC20","name":"_oroBitToken","type":"address"},{"internalType":"address","name":"_stakingAdminWallet","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newPenaltyBP","type":"uint256"}],"name":"EarlyWithdrawPenaltyUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"tokenAddress","type":"address"},{"indexed":true,"internalType":"address","name":"ownerAddress","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"EmergencyTokensWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Paused","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"poolId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"duration","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"aprBP","type":"uint256"},{"indexed":false,"internalType":"bool","name":"isFlexible","type":"bool"}],"name":"PoolAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"poolId","type":"uint256"},{"indexed":false,"internalType":"bool","name":"isActive","type":"bool"}],"name":"PoolStatusUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"depositor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"RewardsDeposited","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"poolId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"stakeId","type":"uint256"}],"name":"Staked","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"oldAddress","type":"address"},{"indexed":true,"internalType":"address","name":"newAddress","type":"address"}],"name":"StakingAdminWalletUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"account","type":"address"}],"name":"Unpaused","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newAPR_BP","type":"uint256"}],"name":"WhaleBonusAPRUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newThreshold","type":"uint256"}],"name":"WhaleThresholdUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"stakeId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"principalAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewardedAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"penaltyAmount","type":"uint256"},{"indexed":false,"internalType":"bool","name":"earlyWithdrawal","type":"bool"}],"name":"Withdrawn","type":"event"},{"inputs":[{"internalType":"uint256","name":"_duration","type":"uint256"},{"internalType":"uint256","name":"_aprBP","type":"uint256"},{"internalType":"bool","name":"_isFlexible","type":"bool"}],"name":"addPool","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"uint256","name":"_stakeId","type":"uint256"}],"name":"calculateReward","outputs":[{"internalType":"uint256","name":"reward","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"depositRewards","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"earlyWithdrawPenaltyBP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_tokenAddress","type":"address"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"emergencyWithdrawToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"getContractTokenBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_poolId","type":"uint256"}],"name":"getPool","outputs":[{"internalType":"uint256","name":"duration","type":"uint256"},{"internalType":"uint256","name":"aprBP","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isFlexible","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getStakingPoolsLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"},{"internalType":"uint256","name":"_stakeId","type":"uint256"}],"name":"getUserStake","outputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"duration","type":"uint256"},{"internalType":"uint256","name":"aprBP","type":"uint256"},{"internalType":"bool","name":"withdrawn","type":"bool"},{"internalType":"uint256","name":"lastRewardClaimTime","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getUserStakesLength","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"oroBitToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"paused","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newPenaltyBP","type":"uint256"}],"name":"setEarlyWithdrawPenalty","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_poolId","type":"uint256"},{"internalType":"bool","name":"_isActive","type":"bool"}],"name":"setPoolStatus","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_newAdminWallet","type":"address"}],"name":"setStakingAdminWallet","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newAPR_BP","type":"uint256"}],"name":"setWhaleBonusAPR","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_newThreshold","type":"uint256"}],"name":"setWhaleThreshold","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_poolId","type":"uint256"},{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"stakingAdminWallet","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"stakingPools","outputs":[{"internalType":"uint256","name":"duration","type":"uint256"},{"internalType":"uint256","name":"aprBP","type":"uint256"},{"internalType":"bool","name":"isActive","type":"bool"},{"internalType":"bool","name":"isFlexible","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"unpause","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"},{"internalType":"uint256","name":"","type":"uint256"}],"name":"userStakes","outputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"startTime","type":"uint256"},{"internalType":"uint256","name":"duration","type":"uint256"},{"internalType":"uint256","name":"aprBP","type":"uint256"},{"internalType":"bool","name":"withdrawn","type":"bool"},{"internalType":"uint256","name":"lastRewardClaimTime","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"whaleBonusAPR_BP","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"whaleThreshold","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_stakeId","type":"uint256"}],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}];


            // --- Variables Globales ---
            let signer;
            let provider;
            let orobitTokenContract;
            let stakingContract;
            let currentAccount = null;
            let tokenDecimals = 18; // Default, will update from contract


            // --- Funciones de Utilidad ---
            // Muestra mensajes personalizados en la DApp (no usa alert() nativo)
            function showMessage(message, type = 'info', duration = 5000) {
                const msgBox = document.getElementById('messageBox');
                msgBox.textContent = message;
                msgBox.className = `message-box ${type}`; // Reinicia clases y añade el tipo
                msgBox.style.display = 'block';

                // Oculta el mensaje después de 'duration' milisegundos
                setTimeout(() => {
                    msgBox.style.display = 'none';
                }, duration);
            }

            // Actualiza la interfaz de usuario con el estado de la cartera y saldos
            async function updateUI() {
                if (!currentAccount || !orobitTokenContract || !stakingContract) {
                    // Si no hay cuenta conectada o contratos no inicializados, mostrar valores por defecto
                    document.getElementById('walletAddress').textContent = 'Conectado: N/A';
                    document.getElementById('walletStatus').classList.add('hidden');
                    document.getElementById('connectWalletBtn').classList.remove('hidden');
                    document.getElementById('stakedBalance').textContent = '0.00 OROBIT';
                    document.getElementById('pendingRewards').textContent = '0.00 OROBIT';
                    document.getElementById('activeStakes').innerHTML = '<p class="text-gray-400">Conecta tu cartera para ver tus stakes.</p>';
                    return;
                }

                try {
                    // Actualizar display de la cartera
                    document.getElementById('walletAddress').textContent = `Conectado: ${currentAccount.substring(0, 6)}...${currentAccount.substring(currentAccount.length - 4)}`;
                    document.getElementById('walletStatus').classList.remove('hidden');
                    document.getElementById('connectWalletBtn').classList.add('hidden');

                    // Obtener decimales del token si aún no se han obtenido
                    if (tokenDecimals === 18) { // Si sigue el valor por defecto
                        try {
                            tokenDecimals = await orobitTokenContract.decimals();
                        } catch (e) {
                            console.warn("No se pudieron obtener los decimales del token, usando 18 por defecto.", e);
                            tokenDecimals = 18; // Fallback
                        }
                    }

                    // Obtener y mostrar balance total de OroBit del usuario
                    const orobitBalanceWei = await orobitTokenContract.balanceOf(currentAccount);
                    const orobitBalanceFormatted = ethers.utils.formatUnits(orobitBalanceWei, tokenDecimals);
                    const availableBalanceSpan = document.getElementById('availableBalance');
                    if (availableBalanceSpan) {
                        availableBalanceSpan.textContent = `${parseFloat(orobitBalanceFormatted).toFixed(4)} OROBIT`;
                    }

                    let totalStakedAmount = ethers.BigNumber.from(0);
                    let totalAccruedRewards = ethers.BigNumber.from(0);
                    let activeStakesHtml = '';
                    let hasActiveStakes = false;

                    const userStakesLength = await stakingContract.getUserStakesLength(currentAccount);

                    if (userStakesLength == 0) {
                        activeStakesHtml = '<p class="text-gray-400">No tienes stakes activos.</p>';
                    } else {
                        for (let i = 0; i < userStakesLength; i++) {
                            const stake = await stakingContract.getUserStake(currentAccount, i);
                            if (!stake.withdrawn) {
                                hasActiveStakes = true;
                                const currentReward = await stakingContract.calculateReward(currentAccount, i);
                                
                                totalStakedAmount = totalStakedAmount.add(stake.amount);
                                totalAccruedRewards = totalAccruedRewards.add(currentReward);

                                // Obtener información del pool para duración y APR
                                const pool = await stakingContract.getPool(stake.poolId); // Usar getPool
                                const durationInDays = pool.duration / (24 * 60 * 60); // Convertir segundos a días
                                const durationText = pool.isFlexible ? "Flexible" : `${durationInDays} Días`;
                                const aprText = (pool.aprBP / BASIS_POINTS_DIVISOR * 100).toFixed(2);
                                const endTime = pool.isFlexible ? 'N/A' : new Date((parseInt(stake.startTime) + parseInt(stake.duration)) * 1000).toLocaleDateString();
                                
                                activeStakesHtml += `
                                    <div class="bg-gray-600 p-4 rounded-md">
                                        <h4 class="font-semibold">Stake ID: ${i} (Pool: ${durationText})</h4>
                                        <p>Cantidad: ${ethers.utils.formatUnits(stake.amount, tokenDecimals)} OROBIT</p>
                                        <p>APR: ${aprText}%</p>
                                        <p>Recompensa Acumulada: ${ethers.utils.formatUnits(currentReward, tokenDecimals)} OROBIT</p>
                                        <p>Inicio: ${new Date(parseInt(stake.startTime) * 1000).toLocaleDateString()}</p>
                                        <p>Fin: ${endTime}</p>
                                    </div>
                                `;
                            }
                        }
                    }
                    
                    document.getElementById('stakedBalance').textContent = `${parseFloat(ethers.utils.formatUnits(totalStakedAmount, tokenDecimals)).toFixed(4)} OROBIT`;
                    document.getElementById('pendingRewards').textContent = `${parseFloat(ethers.utils.formatUnits(totalAccruedRewards, tokenDecimals)).toFixed(4)} OROBIT`;
                    document.getElementById('activeStakes').innerHTML = hasActiveStakes ? activeStakesHtml : '<p class="text-gray-400">No tienes stakes activos.</p>';

                } catch (error) {
                    console.error("Error al actualizar saldos de UI/Dashboard:", error);
                    showMessage("Error al cargar saldos y stakes. Revisa la consola para detalles. Puede que necesites cambiar a la red BNB Smart Chain Testnet en MetaMask.", 'error');
                    document.getElementById('stakedBalance').textContent = 'Error';
                    document.getElementById('pendingRewards').textContent = 'Error';
                    document.getElementById('activeStakes').innerHTML = '<p class="text-red-400">Error al cargar tus stakes. Revisa la consola para detalles.</p>';
                }
            }

            // --- Conexión de Cartera ---
            async function connectWallet() {
                if (typeof window.ethereum !== 'undefined') {
                    try {
                        await window.ethereum.request({ method: 'eth_requestAccounts' });
                        provider = new ethers.providers.Web3Provider(window.ethereum);
                        signer = provider.getSigner();
                        currentAccount = await signer.getAddress();

                        orobitTokenContract = new ethers.Contract(OROBIT_TOKEN_ADDRESS, OROBIT_TOKEN_ABI, signer);
                        stakingContract = new ethers.Contract(STAKING_CONTRACT_ADDRESS, STAKING_CONTRACT_ABI, signer);

                        // Obtener los decimales del token inmediatamente después de inicializar el contrato
                        try {
                            tokenDecimals = await orobitTokenContract.decimals();
                        } catch (e) {
                            console.warn("No se pudieron obtener los decimales del token al conectar, usando 18 por defecto.", e);
                            tokenDecimals = 18; // Fallback
                        }

                        showMessage("Cartera conectada exitosamente!", "success");
                        await updateUI(); // Actualiza la UI con la cartera conectada
                        await renderStakingPools(); // Carga los pools en la pestaña de staking
                        checkAdminAccess(); // Verifica acceso admin

                        window.ethereum.on('accountsChanged', (accounts) => {
                            if (accounts.length > 0) {
                                currentAccount = accounts[0];
                                signer = provider.getSigner();
                                updateUI();
                                renderStakingPools();
                                checkAdminAccess();
                            } else {
                                currentAccount = null;
                                updateUI();
                                showMessage("Cartera desconectada.", "info");
                            }
                        });

                        window.ethereum.on('chainChanged', (chainId) => {
                            window.location.reload(); // Recarga la página para re-inicializar todo en la nueva red
                        });

                    } catch (error) {
                        console.error("Error al conectar la cartera:", error);
                        let errorMessage = "Error al conectar la cartera.";
                        if (error.code === 4001) {
                            errorMessage = "Conexión de cartera rechazada por el usuario en MetaMask.";
                        } else if (error.message) {
                            errorMessage += " Detalle: " + error.message;
                        }
                        showMessage(errorMessage, "error");
                    }
                } else {
                    showMessage("MetaMask no detectado. Por favor, instala MetaMask para usar esta DApp.", "warning");
                    console.error("MetaMask no detectado.");
                }
            }

            // Función para desconectar la cartera (solo a nivel de la DApp)
            function disconnectWallet() {
                currentAccount = null;
                provider = null;
                signer = null;
                orobitTokenContract = null;
                stakingContract = null;
                tokenDecimals = 18; // Reset decimales
                updateUI();
                showMessage("Cartera desconectada.", "info");
            }

            // --- Funciones de Staking ---
            async function renderStakingPools() {
                const selectElement = document.getElementById('stakingPoolSelect');
                if (!stakingContract) {
                    selectElement.innerHTML = '<option value="">Conecta tu cartera para ver los pools</option>';
                    return;
                }
                selectElement.innerHTML = '<option value="">Cargando pools...</option>';

                try {
                    const poolsLength = await stakingContract.getStakingPoolsLength();
                    let optionsHtml = '<option value="">Selecciona un Pool</option>';
                    if (poolsLength == 0) {
                        optionsHtml = '<option value="">No hay pools disponibles</option>';
                    } else {
                        for (let i = 0; i < poolsLength; i++) {
                            const pool = await stakingContract.stakingPools(i);
                            if (pool.isActive) {
                                const durationInDays = pool.duration / (24 * 60 * 60); // Convertir segundos a días
                                const durationText = pool.isFlexible ? "Flexible" : `${durationInDays} Días`;
                                const aprText = (pool.aprBP / BASIS_POINTS_DIVISOR * 100).toFixed(2);
                                optionsHtml += `<option value="${i}">Pool ${durationText} - ${aprText}% APR</option>`;
                            }
                        }
                    }
                    selectElement.innerHTML = optionsHtml;
                } catch (error) {
                    console.error("Error al cargar los pools de staking:", error);
                    selectElement.innerHTML = '<option value="">Error al cargar pools</option>';
                    showMessage("Error al cargar pools de staking: " + error.message, 'error');
                }
            }

            document.getElementById('maxStakeBtn').addEventListener('click', async () => {
                if (!currentAccount || !orobitTokenContract) {
                    showMessage("Por favor, conecta tu cartera primero.", 'warning');
                    return;
                }
                try {
                    const balanceWei = await orobitTokenContract.balanceOf(currentAccount);
                    const balanceFormatted = ethers.utils.formatUnits(balanceWei, tokenDecimals);
                    document.getElementById('stakeAmount').value = parseFloat(balanceFormatted).toFixed(4);
                } catch (error) {
                    console.error("Error al obtener el balance MAX:", error);
                    showMessage("No se pudo obtener el balance máximo.", 'error');
                }
            });

            async function approveOrobit() {
                if (!signer) {
                    showMessage("Por favor, conecta tu cartera primero.", "warning");
                    return;
                }

                const amount = document.getElementById('stakeAmount').value;
                if (isNaN(amount) || parseFloat(amount) <= 0) {
                    showMessage("Introduce una cantidad válida y positiva para aprobar.", "warning");
                    return;
                }
                
                const amountWei = ethers.utils.parseUnits(amount.toString(), tokenDecimals);
                document.getElementById('approvalAmount').textContent = amount;
                document.getElementById('stakingApprovalMessage').classList.remove('hidden');

                showMessage(`Aprobando ${amount} OROBIT para el contrato de staking. Por favor, **revisa y confirma la transacción en tu extensión de MetaMask.**`, "info", 60000);
                
                try {
                    const tx = await orobitTokenContract.approve(STAKING_CONTRACT_ADDRESS, amountWei);
                    await tx.wait(); // Espera a que la transacción sea minada

                    document.getElementById('stakingApprovalMessage').classList.add('hidden');
                    showMessage(`¡${amount} OROBIT aprobados exitosamente! Ahora puedes confirmar el stake.`, "success");
                    updateUI(); // Refrescar el balance disponible
                } catch (error) {
                    console.error("Error al aprobar OroBit:", error);
                    document.getElementById('stakingApprovalMessage').classList.add('hidden');
                    let errorMessage = "Error al aprobar OroBit.";
                    if (error.code === 4001) {
                        errorMessage = "Transacción rechazada por el usuario en MetaMask.";
                    } else if (error.message) {
                        errorMessage += " Detalle: " + error.message;
                    }
                    showMessage(errorMessage, "error");
                }
            }

            async function confirmStake() {
                if (!signer) {
                    showMessage("Por favor, conecta tu cartera primero.", "warning");
                    return;
                }

                const amount = document.getElementById('stakeAmount').value;
                const poolId = document.getElementById('stakingPoolSelect').value;

                if (isNaN(amount) || parseFloat(amount) <= 0) {
                    showMessage("Introduce una cantidad válida y positiva para stakear.", "warning");
                    return;
                }
                if (poolId === "" || isNaN(parseInt(poolId))) {
                    showMessage("Selecciona un pool de staking válido.", "warning");
                    return;
                }
                
                const amountWei = ethers.utils.parseUnits(amount.toString(), tokenDecimals);
                const selectedPoolId = parseInt(poolId);

                try {
                    // Verificar aprobación antes de stakear
                    const allowance = await orobitTokenContract.allowance(currentAccount, STAKING_CONTRACT_ADDRESS);
                    if (allowance.lt(amountWei)) {
                        showMessage("Necesitas aprobar el contrato de staking para gastar esta cantidad de OroBit primero. Haz clic en 'Aprobar OroBit'.", "warning");
                        return;
                    }

                    showMessage(`Staking ${amount} OROBIT en el Pool ID ${selectedPoolId}... Por favor, confirma en MetaMask.`, "info", 60000);
                    // LLAMADA A STAKE CON poolId Y amount
                    const tx = await stakingContract.stake(selectedPoolId, amountWei); 
                    await tx.wait();

                    showMessage(`¡${amount} OROBIT stakeados exitosamente en el Pool ID ${selectedPoolId}!`, "success");
                    document.getElementById('stakeAmount').value = ''; // Limpia el input
                    updateUI(); // Actualiza los saldos y stakes
                } catch (error) {
                    console.error("Error al stakear OroBit:", error);
                    let errorMessage = "Error al stakear OroBit.";
                    if (error.code === 4001) {
                        errorMessage = "Transacción rechazada por el usuario en MetaMask.";
                    } else if (error.message) {
                        errorMessage += " Detalle: " + error.message;
                    }
                    showMessage(errorMessage, "error");
                }
            }

            // --- Funciones de Retiro ---
            document.getElementById('calculateRewardBtn').addEventListener('click', async () => {
                if (!currentAccount || !stakingContract) {
                    showMessage("Por favor, conecta tu cartera primero.", 'warning');
                    return;
                }
                const stakeId = document.getElementById('withdrawStakeId').value;
                if (isNaN(stakeId) || parseInt(stakeId) < 0) {
                    showMessage("Introduce un ID de stake válido y positivo.", 'warning');
                    document.getElementById('calculatedRewardDisplay').classList.add('hidden');
                    return;
                }

                try {
                    const calculatedRewardWei = await stakingContract.calculateReward(currentAccount, parseInt(stakeId));
                    const calculatedRewardFormatted = ethers.utils.formatUnits(calculatedRewardWei, tokenDecimals);
                    document.getElementById('calculatedRewardDisplay').innerHTML = `Recompensa estimada: <span class="font-bold">${parseFloat(calculatedRewardFormatted).toFixed(4)} OROBIT</span>`;
                    document.getElementById('calculatedRewardDisplay').classList.remove('hidden');
                    showMessage("Recompensa calculada.", 'info');
                } catch (error) {
                    console.error("Error al calcular recompensa:", error);
                    document.getElementById('calculatedRewardDisplay').classList.add('hidden');
                    showMessage("Error al calcular recompensa: " + error.message, 'error');
                }
            });

            async function confirmWithdraw() {
                if (!signer) {
                    showMessage("Por favor, conecta tu cartera primero.", "warning");
                    return;
                }

                const stakeId = document.getElementById('withdrawStakeId').value;
                if (isNaN(stakeId) || parseInt(stakeId) < 0) {
                    showMessage("Introduce un ID de stake válido y positivo para retirar.", "warning");
                    return;
                }
                
                const selectedStakeId = parseInt(stakeId);
                document.getElementById('withdrawalId').textContent = selectedStakeId;
                document.getElementById('withdrawalMessage').classList.remove('hidden');

                showMessage(`Retirando Stake ID ${selectedStakeId}... Por favor, confirma en MetaMask.`, "info", 60000);
                
                try {
                    // LLAMADA A WITHDRAW CON stakeId
                    const tx = await stakingContract.withdraw(selectedStakeId); 
                    await tx.wait();

                    document.getElementById('withdrawalMessage').classList.add('hidden');
                    showMessage(`¡Stake ID ${selectedStakeId} retirado exitosamente!`, "success");
                    document.getElementById('withdrawStakeId').value = ''; // Limpia el input
                    document.getElementById('calculatedRewardDisplay').classList.add('hidden');
                    updateUI(); // Actualiza los saldos y stakes
                } catch (error) {
                    console.error("Error al retirar OroBit:", error);
                    document.getElementById('withdrawalMessage').classList.add('hidden');
                    let errorMessage = "Error al retirar OroBit.";
                    if (error.code === 4001) {
                        errorMessage = "Transacción rechazada por el usuario en MetaMask.";
                    } else if (error.message) {
                        errorMessage += " Detalle: " + error.message;
                    }
                    showMessage(errorMessage, "error");
                }
            }

            // --- Funciones de Administración ---
            function checkAdminAccess() {
                const adminPanel = document.getElementById('adminPanel');
                const adminMessage = document.getElementById('adminMessage');
                if (currentAccount && currentAccount.toLowerCase() === OWNER_ADDRESS.toLowerCase()) {
                    adminPanel.classList.remove('hidden');
                    adminMessage.classList.add('hidden');
                } else {
                    adminPanel.classList.add('hidden');
                    adminMessage.classList.remove('hidden');
                }
            }

            document.getElementById('addPoolBtn').addEventListener('click', async () => {
                if (!currentAccount || currentAccount.toLowerCase() !== OWNER_ADDRESS.toLowerCase()) {
                    showMessage("Acceso denegado. Conecta tu cartera de propietario.", 'error');
                    return;
                }
                if (!stakingContract) { showMessage("Contrato de Staking no inicializado.", 'warning'); return; }

                const duration = parseInt(document.getElementById('adminPoolDuration').value);
                const apr = parseInt(document.getElementById('adminPoolAPR').value);
                const isFlexible = document.getElementById('adminIsFlexiblePool').checked;

                if (isNaN(duration) || isNaN(apr)) { showMessage("Introduce valores válidos para duración y APR.", 'warning'); return; }

                showMessage("Añadiendo nuevo pool de staking. Por favor, confirma en MetaMask.", 'info', 60000);
                try {
                    const tx = await stakingContract.addPool(duration, apr, isFlexible);
                    await tx.wait();
                    showMessage(`Pool añadido exitosamente.`, 'success');
                    renderStakingPools(); // Recargar pools
                } catch (error) {
                    console.error("Error al añadir pool:", error);
                    let errorMessage = `Error al añadir pool: ${error.message}.`;
                    if (error.code === 4001) { errorMessage = "Transacción rechazada por el usuario."; }
                    showMessage(errorMessage, 'error');
                }
            });

            // --- Event Listeners y Lógica de UI ---
            // Lógica para el cambio de pestañas
            const tabs = {
                'miDashboardTab': 'miDashboardContent',
                'stakeTab': 'stakeContent',
                'withdrawTab': 'withdrawContent',
                'adminTab': 'adminContent'
            };

            function switchTab(activeTabId) {
                for (const tabId in tabs) {
                    document.getElementById(tabId).classList.remove('active', 'bg-gray-500');
                    document.getElementById(tabId).classList.add('bg-gray-600');
                    document.getElementById(tabs[tabId]).classList.add('hidden');
                }
                document.getElementById(activeTabId).classList.add('active', 'bg-gray-500');
                document.getElementById(activeTabId).classList.remove('bg-gray-600');
                document.getElementById(tabs[activeTabId]).classList.remove('hidden');

                // Asegurar que la UI se actualice al cambiar de pestaña
                if (activeTabId === 'miDashboardTab' && currentAccount) {
                    updateUI();
                } else if (activeTabId === 'stakeTab' && currentAccount) {
                    updateUI(); // Para actualizar el balance disponible
                    renderStakingPools();
                } else if (activeTabId === 'adminTab' && currentAccount) {
                    checkAdminAccess();
                }
            }

            for (const tabId in tabs) {
                document.getElementById(tabId).addEventListener('click', () => switchTab(tabId));
            }

            // Muestra el Dashboard por defecto al cargar la página
            switchTab('miDashboardTab');

            // Botones de Cartera
            document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
            document.getElementById('disconnectWalletBtn').addEventListener('click', disconnectWallet);

            // Botones de Staking
            document.getElementById('approveStakeBtn').addEventListener('click', approveOrobit);
            document.getElementById('confirmStakeBtn').addEventListener('click', confirmStake);
           
            // Botones de Retiro
            document.getElementById('confirmWithdrawBtn').addEventListener('click', confirmWithdraw);
            
            // Botón de admin
            document.getElementById('addPoolBtn').addEventListener('click', () => { /* Logic handled in separate func */ });


            // Intenta autoconectar MetaMask si ya estaba logeado de una sesión anterior
            if (typeof window.ethereum !== 'undefined' && window.ethereum.selectedAddress) {
                connectWallet();
            }
        } // Fin de initializeDApp()

        // NOTA IMPORTANTE (información recordada): Aunque el token se llama "OroBit",
        // el proyecto o ecosistema más amplio puede tener un nombre más distintivo
        // para evitar confusiones.
        console.log("Nota: Aunque el token se llama 'OroBit', el proyecto o ecosistema más amplio puede tener un nombre más distintivo para evitar confusiones.");
    </script>
</body>
</html>
